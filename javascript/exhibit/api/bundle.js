

/* browse-engine.js */

Exhibit.BrowseEngine=function(database,configuration){this._database=database;this._listeners=new SimileAjax.ListenerQueue("onChange");this._facetPaths=[];this._facetIDs=[];this._supportSliding=false;if("BrowseEngine"in configuration){var myConfig=configuration["BrowseEngine"];if("facets"in myConfig){this.setFacets(myConfig["facets"]);}
if("sliding"in myConfig&&myConfig.sliding){this._supportSliding=true;}}
var self=this;this._databaseListener={onAfterLoadingItems:function(){delete self._cachedRootFacets;}};this._database.addListener(this._databaseListener);this._collections=[];this._slides=[];};Exhibit.BrowseEngine.prototype.dispose=function(){this._database.removeListener(this._databaseListener);};Exhibit.BrowseEngine.prototype.addListener=function(listener){this._listeners.add(listener);};Exhibit.BrowseEngine.prototype.removeListener=function(listener){this._listeners.remove(listener);};Exhibit.BrowseEngine.prototype.getState=function(){return null;};Exhibit.BrowseEngine.prototype.setState=function(state){};Exhibit.BrowseEngine.prototype.setFacets=function(facetEntries){var showHelp=function(expr){Exhibit.showHelp(Exhibit.BrowseEngine.l10n.errorParsingFacetExpressionMessage(expr),Exhibit.docRoot+"Exhibit/Configuring_Browse_Panel");};for(var i=0;i<facetEntries.length;i++){var entry=facetEntries[i];try{var expression=Exhibit.Expression.parse(entry);if(expression.isPath()){this._facetPaths.push(expression.getPath());this._facetIDs.push(entry);}else{showHelp(entry);break;}}catch(e){SimileAjax.Debug.exception("BrowseEngine.setFacets failed to parse facet expressions",e);showHelp(entry);break;}}};Exhibit.BrowseEngine.prototype.getFocus=function(){for(var i=0;i<this._collections.length;i++){var c=this._collections[i];if(c._focused){return i;}}
return-1;};Exhibit.BrowseEngine.prototype.getCollectionCount=function(){return this._collections.length;}
Exhibit.BrowseEngine.prototype.getCurrentCollection=function(){return this.getCollection(this.getFocus());};Exhibit.BrowseEngine.prototype.getCollection=function(index){var length=this._collections.length;return(index>=0&&index<length)?this._collections[index]:null;}
Exhibit.BrowseEngine.prototype.getSlide=function(index){var length=this._slides.length;return(index>=0&&index<length)?this._slides[index]:null;}
Exhibit.BrowseEngine.prototype.getFacets=function(){var facets=[];var focusIndex=this.getFocus();if(focusIndex>=0){var collection=this._collections[focusIndex];var isRoot=(focusIndex==0);var empty=true;if(isRoot){for(var i=0;i<collection._restrictions.length;i++){var r=collection._restrictions[i];if(r.hasSelection()){empty=false;break;}}}
if(isRoot&&empty&&"_cachedRootFacets"in this){facets=this._cachedRootFacets;}else{for(var i=0;i<collection._restrictions.length;i++){var r=collection._restrictions[i];this._computeFacet(collection,r,facets);}
if(isRoot&&empty){this._cachedRootFacets=facets;}}}
return facets;};Exhibit.BrowseEngine.prototype.getFacet=function(facetID){var facets=[];var focusIndex=this.getFocus();if(focusIndex>=0){var collection=this._collections[focusIndex];for(var i=0;i<collection._restrictions.length;i++){var r=collection._restrictions[i];if(r.id==facetID){this._computeFacet(collection,r,facets);break;}}}
return facets.length>0?facets[0]:null;};Exhibit.BrowseEngine.prototype.getGroups=function(facetID){var focusIndex=this.getFocus();var collection=this._collections[focusIndex];for(var i=0;i<collection._restrictions.length;i++){var restriction=collection._restrictions[i];if(restriction.id==facetID){return this._getGroups(collection,restriction);}}
return[];};Exhibit.BrowseEngine.prototype.setRootCollection=function(itemSet){if(itemSet!=null){this._collections=[];this._slides=[];this._addCollection(itemSet)._focused=true;delete this._cachedRootFacets;this._listeners.fire("onRootCollectionSet",[]);}else{SimileAjax.Debug.log("Exhibit.BrowseEngine.setRootCollection is called with null argument");}};Exhibit.BrowseEngine.prototype.setValueRestriction=function(facetID,level,value,selected){var focusIndex=this.getFocus();if(focusIndex>=0&&focusIndex<this._collections.length){var collection=this._collections[focusIndex];for(var i=0;i<collection._restrictions.length;i++){var restriction=collection._restrictions[i];if(restriction.id==facetID){restriction.setSelection(level,value,selected);collection._restrictedSet=this._restrict(collection._originalSet,collection._restrictions,null);this._propagateChanges(focusIndex);this._listeners.fire("onRestrict",[]);return;}}
SimileAjax.Debug.log("Exhibit.BrowseEngine.setValueRestriction is called with an invalid id");}else{SimileAjax.Debug.log("Exhibit.BrowseEngine.setValueRestriction is called when there is no collection");}};Exhibit.BrowseEngine.prototype.focus=function(index){for(var i=0;i<this._collections.length;i++){var c=this._collections[i];c._focused=(i==index);}};Exhibit.BrowseEngine.prototype.clearRestrictions=function(){var focusIndex=this.getFocus();if(focusIndex>=0&&focusIndex<this._collections.length){var collection=this._collections[focusIndex];var oldRestrictions=collection._restrictions;collection._restrictions=[];collection._restrictedSet=collection._originalSet;this._initializeRestrictions(collection);this._propagateChanges(focusIndex);this._listeners.fire("onClearRestrictions",[]);return oldRestrictions;}else{SimileAjax.Debug.log("Exhibit.BrowseEngine.clearRestrictions is called when there is no collection");return null;}}
Exhibit.BrowseEngine.prototype.applyRestrictions=function(restrictions){var focusIndex=this.getFocus();if(focusIndex>=0&&focusIndex<this._collections.length){var collection=this._collections[focusIndex];collection._restrictions=restrictions;collection._restrictedSet=this._restrict(collection._originalSet,collection._restrictions,null);this._propagateChanges(focusIndex);this._listeners.fire("onApplyRestrictions",[]);}else{SimileAjax.Debug.log("Exhibit.BrowseEngine.applyRestrictions is called when there is no collection");}}
Exhibit.BrowseEngine.prototype.clearFacetRestrictions=function(facetID){var focusIndex=this.getFocus();if(focusIndex>=0&&focusIndex<this._collections.length){var collection=this._collections[focusIndex];for(var i=0;i<collection._restrictions.length;i++){var restriction=collection._restrictions[i];if(restriction.id==facetID){var oldRestriction=restriction;collection._restrictions[i]=new Exhibit.BrowseEngine._Restriction(oldRestriction.path,facetID);collection._restrictedSet=this._restrict(collection._originalSet,collection._restrictions,null);this._propagateChanges(focusIndex);this._listeners.fire("onClearFacetRestrictions",[]);return oldRestriction;}}
SimileAjax.Debug.log("Exhibit.BrowseEngine.clearFacetRestrictions is called with an invalid id");return null;}else{SimileAjax.Debug.log("Exhibit.BrowseEngine.clearFacetRestrictions is called when there is no collection");return null;}}
Exhibit.BrowseEngine.prototype.applyFacetRestrictions=function(facetID,restrictions){if(restrictions!=null){var focusIndex=this.getFocus();if(focusIndex>=0&&focusIndex<this._collections.length){var collection=this._collections[focusIndex];for(var i=0;i<collection._restrictions.length;i++){var restriction=collection._restrictions[i];if(restriction.id==facetID){collection._restrictions[i]=restrictions;collection._restrictedSet=this._restrict(collection._originalSet,collection._restrictions,null);this._propagateChanges(focusIndex);this._listeners.fire("onApplyFacetRestrictions",[]);return;}}
SimileAjax.Debug.log("Exhibit.BrowseEngine.applyFacetRestrictions is called with an invalid id");}else{SimileAjax.Debug.log("Exhibit.BrowseEngine.applyFacetRestrictions is called when there is no collection");}}}
Exhibit.BrowseEngine.prototype.truncate=function(index){var focusIndex=this.getFocus();if(focusIndex>=0&&focusIndex<this._collections.length){if(index>0){this._collections=this._collections.slice(0,index);this._slides=this._slides.slice(0,index-1);if(focusIndex>=index){this.focus(index-1);}}
this._listeners.fire("onTruncate",[]);}else{SimileAjax.Debug.log("Exhibit.BrowseEngine.truncate is called when there is no collection");}}
Exhibit.BrowseEngine.prototype.group=function(facetID,level,groupingProperty,groupingForward){var focusIndex=this.getFocus();if(focusIndex>=0&&focusIndex<this._collections.length){var collection=this._collections[focusIndex];for(var i=0;i<collection._restrictions.length;i++){var restriction=collection._restrictions[i];if(restriction.id==facetID){if(this._group(collection,restriction,level,groupingProperty,groupingForward)){collection._restrictedSet=this._restrict(collection._originalSet,collection._restrictions,null);this._propagateChanges(focusIndex);this._listeners.fire("onRestrict",[]);}
this._listeners.fire("onGroup",[]);return;}}
SimileAjax.Debug.log("Exhibit.BrowseEngine.group is called with an invalid id");}else{SimileAjax.Debug.log("Exhibit.BrowseEngine.group is called when there is no collection");}};Exhibit.BrowseEngine.prototype.ungroup=function(facetID,level){var focusIndex=this.getFocus();if(focusIndex>=0&&focusIndex<this._collections.length){var collection=this._collections[focusIndex];for(var i=0;i<collection._restrictions.length;i++){var restriction=collection._restrictions[i];if(restriction.id==facetID){if(this._ungroup(collection,restriction,level)){collection._restrictedSet=this._restrict(collection._originalSet,collection._restrictions,null);this._propagateChanges(focusIndex);this._listeners.fire("onRestrict",[]);}
this._listeners.fire("onUngroup",[]);return;}}
SimileAjax.Debug.log("Exhibit.BrowseEngine.ungroup is called with an invalid id");}else{SimileAjax.Debug.log("Exhibit.BrowseEngine.ungroup is called when there is no collection");}};Exhibit.BrowseEngine.prototype._addCollection=function(itemSet){var c=new Exhibit.BrowseEngine._Collection(itemSet);this._initializeRestrictions(c);this._collections.push(c);return c;};Exhibit.BrowseEngine.prototype._initializeRestrictions=function(collection){for(var i=0;i<this._facetPaths.length;i++){collection._restrictions.push(new Exhibit.BrowseEngine._Restriction(this._facetPaths[i],this._facetIDs[i]));}};Exhibit.BrowseEngine.prototype._createFacetTemplate=function(r,values,valueType,slideSet){var segment=r.getPath(-1).getLastSegment();var property=segment.property;var forward=segment.forward;var propertyData=this._database.getProperty(property);var facetLabel=forward?propertyData.getPluralLabel():propertyData.getReversePluralLabel();var typeLabels=this._database.getTypeLabels(values);var valueLabel=typeLabels[0].length>0?typeLabels[0].join(", "):"option";var pluralValueLabel=typeLabels[1].length>0?typeLabels[1].join(", "):"options";var itemValues=(!forward||propertyData.getValueType()=="item");return{facetID:r.id,facetLabel:facetLabel,valueLabel:valueLabel,pluralValueLabel:pluralValueLabel,count:values.size(),selectedCount:0,filteredCount:slideSet.size(),groupLevelCount:r.getLevelCount(),slidable:this._supportSliding&&itemValues,groupable:itemValues,values:[]};};Exhibit.BrowseEngine.prototype._computeFacet=function(collection,r,facets){var database=this._database;var currentSet=this._restrict(collection._originalSet,collection._restrictions,r);var results=r.getPath().walkForward(currentSet,"item",database);var values=results.values;if(values.size()==0){return;}
var slideSet=r.getPath().walkForward(collection.getCurrentSet(),"item",database).values;var facet=this._createFacetTemplate(r,values,results.valueType,slideSet);var f=function(level,domainSets,valueToFacetValueMap){var domainSet=domainSets[domainSets.length-1];var path=r.getPath(level);var resultStruct=path.walkForward(domainSet,"item",database);var rangeSet=resultStruct.values;var rangeValuesAreItems=resultStruct.valueType=="item";var previousSelectedRangeSet=r.getValueSet(level);if(previousSelectedRangeSet){rangeSet.addSet(previousSelectedRangeSet);facet.selectedCount+=previousSelectedRangeSet.size();}
var results=[];var map={};rangeSet.visit(function(rangeValue){var domainSubset=path.evaluateBackward(rangeValue,"item",domainSet,database).values;var firstDomainSubset=domainSubset;for(var i=level-1;i>=-1;i--){firstDomainSubset=r.getPath(i).walkBackward(firstDomainSubset,"item",domainSets[i+1],database).values;}
var label=rangeValuesAreItems?database.getObject(rangeValue,"label"):rangeValue;var facetValue={value:rangeValue,count:firstDomainSubset.size(),label:label!=null?label:rangeValue,selected:(previousSelectedRangeSet)?previousSelectedRangeSet.contains(rangeValue):false,filtered:level==-1&&slideSet.contains(rangeValue),level:level,children:[]};if(valueToFacetValueMap){domainSubset.visit(function(domainValue){var childFacetValue=valueToFacetValueMap[domainValue];facetValue.children.push(childFacetValue);});facetValue.children.sort(function(a,b){return a.label.localeCompare(b.label);});}
results.push(facetValue);map[rangeValue]=facetValue;});if(level<r.getLevelCount()-1){domainSets.push(rangeSet);return arguments.callee(level+1,domainSets,map);}else{results.sort(function(a,b){return a.label.localeCompare(b.label);});return results;}};facet.values=f(-1,[currentSet],null);facets.push(facet);};Exhibit.BrowseEngine.prototype._restrict=function(itemSet,restrictions,except){var database=this._database;var recurseGetRestrictionValues=function(restriction,level,results,intersectResultsWith){var path=restriction.getPath(level);var rangeSet=new Exhibit.Set();var userSelectedSet=restriction.getValueSet(level);if(userSelectedSet&&userSelectedSet.size()>0){rangeSet.addSet(userSelectedSet);}
if(level<restriction.getLevelCount()-1){recurseGetRestrictionValues(restriction,level+1,rangeSet,null);}
if(rangeSet.size()>0){results.addSet(path.walkBackward(rangeSet,"item",intersectResultsWith,database).values);return results;}else{return intersectResultsWith;}}
for(var i=0;i<restrictions.length;i++){var restriction=restrictions[i];if(restriction!=except&&restriction.hasSelection()){itemSet=recurseGetRestrictionValues(restriction,-1,new Exhibit.Set(),itemSet);}}
return itemSet;};Exhibit.BrowseEngine.prototype._propagateChanges=function(index){}
Exhibit.BrowseEngine.prototype._getGroups=function(collection,restriction){var database=this._database;var results=[];var groupings=restriction.groupings;var x=restriction.getPath().walkForward(collection._restrictedSet,"item",database);var set=x.values;var lastSetCanBeGroupedFurther=x.valueType=="item";for(var i=0;i<groupings.length;i++){var groupingOptions=this._getGroupingOptions(set);var result={groupingOptions:groupingOptions};var grouping=groupings[i];var groupingProperty=grouping.property;var groupingForward=grouping.forward;lastSetCanBeGroupedFurther=false;for(var j=0;j<groupingOptions.length;j++){var groupingOption=groupingOptions[j];if(groupingOption.property==groupingProperty&&groupingOption.forward==groupingForward){x=Exhibit.Expression.Path.create(groupingProperty,groupingForward).walkForward(set,"item",database);set=x.values;lastSetCanBeGroupedFurther=x.valueType=="item";groupingOption.selected=true;result.grouped=true;break;}}
results.push(result);}
if(lastSetCanBeGroupedFurther){results.push({groupingOptions:this._getGroupingOptions(set)});}
return results;};Exhibit.BrowseEngine.prototype._group=function(collection,restriction,level,groupingProperty,groupingForward){var changed=false;if(level<restriction.groupings.length){for(var i=level;i<restriction.groupings.length;i++){var selection=restriction.groupings[i].valueSet;if(selection!=null&&selection.size()>0){changed=true;break;}}
restriction.groupings=restriction.groupings.slice(0,level);}
restriction.groupings.push({property:groupingProperty,forward:groupingForward});return changed;};Exhibit.BrowseEngine.prototype._ungroup=function(collection,restriction,level){var changed=false;if(level<restriction.groupings.length){for(var i=level;i<restriction.groupings.length;i++){var selection=restriction.groupings[i].valueSet;if(selection!=null&&selection.size()>0){changed=true;break;}}
restriction.groupings=restriction.groupings.slice(0,level);}
return changed;};Exhibit.BrowseEngine.prototype._getGroupingOptions=function(set){var options=[];var propertyIDs=this._database.getAllProperties();for(var i=0;i<propertyIDs.length;i++){var propertyID=propertyIDs[i];if(propertyID!="label"&&propertyID!="uri"){var property=this._database.getProperty(propertyID);var objects=this._database.getObjectsUnion(set,propertyID);if(objects.size()>0){options.push({property:propertyID,forward:true,label:property.getGroupingLabel(),further:property.getValueType()=="item"});}
if(false){if(this._database.getSubjectsUnion(set,p).size()){options.push({property:p,reverse:true,label:data.reverseGroupingLabel,further:true});}}}}
return options;};Exhibit.BrowseEngine._Restriction=function(path,id){this.id=id;this.path=path;this.valueSet=null;this.groupings=[];this.selectedCount=0;}
Exhibit.BrowseEngine._Restriction.prototype.hasSelection=function(){return this.selectedCount>0;}
Exhibit.BrowseEngine._Restriction.prototype.clearSelection=function(){this.valueSet=null;for(var i=0;i<this.groupings.length;i++){this.groupings[i].valueSet=null;}
this.selectedCount=0;}
Exhibit.BrowseEngine._Restriction.prototype.setSelection=function(level,value,selected){if(selected){if(level==-1){if(!this.valueSet){this.valueSet=new Exhibit.Set();}
if(this.valueSet.add(value)){this.selectedCount++;}}else{var grouping=this.groupings[level];if(!grouping.valueSet){grouping.valueSet=new Exhibit.Set();}
if(grouping.valueSet.add(value)){this.selectedCount++;}}}else{if(level==-1){if(this.valueSet){if(this.valueSet.remove(value)){this.selectedCount--;}}}else{var grouping=this.groupings[level];if(grouping.valueSet){if(grouping.valueSet.remove(value)){this.selectedCount--;}}}}}
Exhibit.BrowseEngine._Restriction.prototype.getValueSet=function(level){return level<0?this.valueSet:this.groupings[level].valueSet;}
Exhibit.BrowseEngine._Restriction.prototype.getPath=function(level){if(level<0||level==undefined){return this.path;}else if(level<this.groupings.length){var grouping=this.groupings[level];return Exhibit.Expression.Path.create(grouping.property,grouping.forward);}else{throw new Error("No such level in restriction");}}
Exhibit.BrowseEngine._Restriction.prototype.getLevelCount=function(){return this.groupings.length;}
Exhibit.BrowseEngine._Collection=function(itemSet){this._originalSet=itemSet;this._restrictedSet=itemSet;this._restrictions=[];this._focused=false;}
Exhibit.BrowseEngine._Collection.prototype.size=function(){return this._restrictedSet.size();}
Exhibit.BrowseEngine._Collection.prototype.originalSize=function(){return this._originalSet.size();}
Exhibit.BrowseEngine._Collection.prototype.getCurrentSet=function(){return this._restrictedSet;}
Exhibit.BrowseEngine._Collection.prototype.getOriginalSet=function(){return this._originalSet;}
Exhibit.BrowseEngine._Collection.prototype.hasFocus=function(){return this._focused;}
Exhibit.BrowseEngine._Collection.prototype.getRestrictedSet=function(){return this._restrictedSet;}

/* browse-panel.js */

Exhibit.BrowsePanel=function(exhibit,div,configuration){if(configuration==null){var o=Exhibit.getAttribute(div,"configuration");if(o!=null&&o.length>0){try{o=eval(o);if(typeof o=="object"){configuration=o;}else{SimileAjax.Debug.log("The ex:configuration attribute value in <div id=\"exhibit-browse-panel\"> does not evaluate to an object");}}catch(e){SimileAjax.Debug.exception("The ex:configuration attribute value in <div id=\"exhibit-browse-panel\"> is not a valid Javascript expression",e);}}}
this._exhibit=exhibit;this._database=exhibit.getDatabase();this._browseEngine=exhibit.getBrowseEngine();this._div=div;this._configure(configuration);this._facetInfos=[];var browsePanel=this;this._browseEngine.addListener({onChange:function(handlerName){if(handlerName!="onGroup"&&handlerName!="onUngroup"){browsePanel._reconstruct();}}});this._initializeUI();};Exhibit.BrowsePanel.prototype.getState=function(){return null;};Exhibit.BrowsePanel.prototype.setState=function(state){};Exhibit.BrowsePanel.prototype._configure=function(configuration){if(configuration==null||!("BrowseEngine"in configuration)){var s=Exhibit.getAttribute(this._div,"facets");if(s!=null&&s.length>0){var a=s.split(",");for(var i=0;i<a.length;i++){a[i]=a[i].trim();}
this._browseEngine.setFacets(a);}}};Exhibit.BrowsePanel.prototype._initializeUI=function(){this._div.innerHTML="";Exhibit.protectUI(this._div);SimileAjax.DOM.appendClassName(this._div,"exhibit-browsePanel");var logoColor="Silver";var s=Exhibit.getAttribute(document.body,"exhibitLogoColor");if(s!=null&&s.length>0){logoColor=s;}
this._dom=Exhibit.BrowsePanel.theme.constructBrowsePanel(this._exhibit,this._div,"http://static.simile.mit.edu/graphics/logos/exhibit/exhibit-small-"+logoColor+".png");};Exhibit.BrowsePanel.prototype._reconstruct=function(){var newFacets=this._browseEngine.getFacets();if(newFacets.length>0){this._reconstructFacets(newFacets);}else{this._showHelp();}};Exhibit.BrowsePanel.prototype.getFacet=function(id,pos){for(var i=0,facet;facet=this._facetInfos[i];i++)
if(facet.facetID==id)
return pos?{pos:i,facet:facet.facet}:facet.facet;};Exhibit.BrowsePanel.prototype.hideFacet=function(id){var old=this.getFacet(id,1);if(!old)
return false;this._facetInfos.splice(old.pos,1);old.facet.dispose();return true;};Exhibit.BrowsePanel.prototype.facetVisible=function(id){return!!this.getFacet(id);};Exhibit.BrowsePanel.prototype.toggleFacet=function(id){var wasShown=this.facetVisible(id);if(wasShown)
this.hideFacet(id);else
this.showFacet(id);return wasShown;};Exhibit.BrowsePanel.prototype.showFacet=function(id){var shown={},facetInfo,i,wasShown;for(i=0;facetInfo=this._facetInfos[i];i++)
shown[facetInfo.facetID]=true;wasShown=shown[id];shown[id]=true;var allFacets=this._browseEngine.getFacets();var newFacets=[];for(i=0;facetInfo=allFacets[i];i++)
if(shown[facetInfo.facetID])
newFacets.push(facetInfo);this._reconstructFacets(newFacets);return wasShown;};Exhibit.BrowsePanel.prototype._showHelp=function(){};Exhibit.BrowsePanel.prototype._reconstructFacets=function(newFacets){var facetContainer=this._dom.facetContainer;var getKey=function(f){return f.facetID;};var newFacetKeys={};for(var i=0;i<newFacets.length;i++){var facet=newFacets[i];var key=getKey(facet);newFacetKeys[key]=true;}
var oldFacets=this._facetInfos;var oldFacetKeys={};for(i=0;i<oldFacets.length;i++){var facet=oldFacets[i];var key=getKey(facet);if(!(newFacetKeys[key])){oldFacetKeys[key]=true;}}
var newFacetInfos=[];var newFacetIndex=0;var oldFacetIndex=0;var node=facetContainer.firstChild;while(newFacetIndex<newFacets.length&&oldFacetIndex<oldFacets.length){var oldFacet=oldFacets[oldFacetIndex];var oldFacetKey=getKey(oldFacet);if(oldFacetKeys[oldFacetKey]){node=node.nextSibling;oldFacet.facet.dispose();oldFacetIndex++;}else{var newFacet=newFacets[newFacetIndex];var newFacetKey=getKey(newFacet);if(newFacetKey==oldFacetKey){node=node.nextSibling;oldFacet.facet.update(newFacet);newFacetInfos.push(oldFacet);newFacetIndex++;oldFacetIndex++;}else{var result=this._constructFacet(newFacet);if(node==null){facetContainer.appendChild(result[0]);}else{facetContainer.insertBefore(result[0],node);}
newFacetInfos.push({facetID:newFacet.facetID,facet:result[1]});newFacetIndex++;}}}
while(newFacetIndex<newFacets.length){var newFacet=newFacets[newFacetIndex];var result=this._constructFacet(newFacet);if(node==null){facetContainer.appendChild(result[0]);}else{facetContainer.insertBefore(result[0],node);}
newFacetInfos.push({facetID:newFacet.facetID,facet:result[1]});newFacetIndex++;}
while(oldFacetIndex<oldFacets.length){var oldFacet=oldFacets[oldFacetIndex];var oldFacetKey=getKey(oldFacet);if(!(oldFacetKey in oldFacetKeys)){SimileAjax.Debug.log("Facet merging algorithm is broken "+oldFacetKey);}
oldFacet.facet.dispose();oldFacetIndex++;}
this._facetInfos=newFacetInfos;};Exhibit.BrowsePanel.prototype._constructFacet=function(facet){var facetDiv=document.createElement("div");var listFacet=new Exhibit.ListFacet(this._exhibit,facet,facetDiv,this._configuration);return[facetDiv,listFacet];};

/* control-panel.js */

Exhibit.ControlPanel=function(exhibit,div,configuration){if(configuration==null){var o=Exhibit.getAttribute(div,"configuration");if(o!=null&&o.length>0){try{o=eval(o);if(typeof o=="object"){configuration=o;}else{SimileAjax.Debug.log("The ex:configuration attribute value in <div id=\"exhibit-control-panel\"> does not evaluate to an object");}}catch(e){SimileAjax.Debug.exception("The ex:configuration attribute value in <div id=\"exhibit-browse-panel\"> is not a valid Javascript expression",e);}}}
this._exhibit=exhibit;this._div=div;this._configuration=configuration;var s=Exhibit.getAttribute(this._div,"exporters");if(s!=null&&s.length>0){var showHelp=function(expr){Exhibit.showHelp(Exhibit.ControlPanel.l10n.badExporterExpressionMessage(expr),Exhibit.docRoot+"Exhibit/Configuring_Exporters");};var a=s.split(",");for(var i=0;i<a.length;i++){var expr=a[i].trim();try{var o=eval(expr);if(typeof o=="object"){exhibit.addExporter(o);}else{showHelp(expr);break;}}catch(e){SimileAjax.Debug.exception("ControlPanel failed to parse ex:exporters",e);showHelp(expr);break;}}}
this._initializeUI();}
Exhibit.ControlPanel.prototype.getState=function(){return null;};Exhibit.ControlPanel.prototype.setState=function(state){};Exhibit.ControlPanel.prototype._initializeUI=function(){};

/* create.js */

(function(){if(document.body==null&&window.onload==null){var f=function(){if(document.body.onload==null||document.body.onload==f){window.exhibit=Exhibit.create();}};window.onload=f;}})();

/* database.js */

Exhibit.Database=function(){this._types={};this._properties={};this._propertyArray={};this._listeners=new SimileAjax.ListenerQueue();this._spo={};this._ops={};this._items=new Exhibit.Set();var l10n=Exhibit.Database.l10n;var itemType=new Exhibit.Database._Type("Item");itemType._uri="http://simile.mit.edu/2006/11/exhibit#Item";itemType._label=l10n.itemType.label;itemType._pluralLabel=l10n.itemType.pluralLabel;this._types["Item"]=itemType;var labelProperty=new Exhibit.Database._Property("label");labelProperty._uri="http://www.w3.org/2000/01/rdf-schema#label";labelProperty._valueType="text";labelProperty._label=l10n.labelProperty.label;labelProperty._pluralLabel=l10n.labelProperty.pluralLabel;labelProperty._reverseLabel=l10n.labelProperty.reverseLabel;labelProperty._reversePluralLabel=l10n.labelProperty.reversePluralLabel;labelProperty._groupingLabel=l10n.labelProperty.groupingLabel;labelProperty._reverseGroupingLabel=l10n.labelProperty.reverseGroupingLabel;this._properties["label"]=labelProperty;var typeProperty=new Exhibit.Database._Property("type");typeProperty._uri="http://www.w3.org/1999/02/22-rdf-syntax-ns#type";typeProperty._valueType="text";typeProperty._label="type";typeProperty._pluralLabel=l10n.typeProperty.label;typeProperty._reverseLabel=l10n.typeProperty.reverseLabel;typeProperty._reversePluralLabel=l10n.typeProperty.reversePluralLabel;typeProperty._groupingLabel=l10n.typeProperty.groupingLabel;typeProperty._reverseGroupingLabel=l10n.typeProperty.reverseGroupingLabel;this._properties["type"]=typeProperty;var uriProperty=new Exhibit.Database._Property("uri");uriProperty._uri="http://simile.mit.edu/2006/11/exhibit#uri";uriProperty._valueType="url";uriProperty._label="URI";uriProperty._pluralLabel="URIs";uriProperty._reverseLabel="URI of";uriProperty._reversePluralLabel="URIs of";uriProperty._groupingLabel="URIs";uriProperty._reverseGroupingLabel="things named by these URIs";this._properties["uri"]=uriProperty;};Exhibit.Database.prototype.addListener=function(listener){this._listeners.add(listener);};Exhibit.Database.prototype.removeListener=function(listener){this._listeners.remove(listener);};Exhibit.Database.prototype.loadTypes=function(typeEntries,baseURI){this._listeners.fire("onBeforeLoadingTypes",[]);try{var lastChar=baseURI.substr(baseURI.length-1)
if(lastChar=="#"){baseURI=baseURI.substr(0,baseURI.length-1)+"/";}else if(lastChar!="/"&&lastChar!=":"){baseURI+="/";}
for(typeID in typeEntries){if(typeID!=undefined&&typeID!=null){var typeEntry=typeEntries[typeID];var type;if(typeID in this._types){type=this._types[typeID];}else{type=new Exhibit.Database._Type(typeID);this._types[typeID]=type;};type._uri=("uri"in typeEntry)?typeEntry.uri:(baseURI+"type#"+encodeURIComponent(typeID));type._label=("label"in typeEntry)?typeEntry.label:typeID;type._pluralLabel=("pluralLabel"in typeEntry)?typeEntry.pluralLabel:type._label;}}
this._listeners.fire("onAfterLoadingTypes",[]);}catch(e){SimileAjax.Debug.exception("Database.loadTypes failed",e);}};Exhibit.Database.prototype.loadProperties=function(propertyEntries,baseURI){this._listeners.fire("onBeforeLoadingProperties",[]);try{var lastChar=baseURI.substr(baseURI.length-1)
if(lastChar=="#"){baseURI=baseURI.substr(0,baseURI.length-1)+"/";}else if(lastChar!="/"&&lastChar!=":"){baseURI+="/";}
for(propertyID in propertyEntries){var propertyEntry=propertyEntries[propertyID];var property;if(propertyID in this._properties){property=this._properties[propertyID];}else{property=new Exhibit.Database._Property(propertyID,this);this._properties[propertyID]=property;};property._uri=("uri"in propertyEntry)?propertyEntry.uri:(baseURI+"property#"+encodeURIComponent(propertyID));property._valueType=("valueType"in propertyEntry)?propertyEntry.valueType:"text";property._label=("label"in propertyEntry)?propertyEntry.label:propertyID;property._pluralLabel=("pluralLabel"in propertyEntry)?propertyEntry.pluralLabel:property._label;property._reverseLabel=("reverseLabel"in propertyEntry)?propertyEntry.reverseLabel:("!"+property._label);property._reversePluralLabel=("reversePluralLabel"in propertyEntry)?propertyEntry.reversePluralLabel:("!"+property._pluralLabel);property._groupingLabel=("groupingLabel"in propertyEntry)?propertyEntry.groupingLabel:property._label;property._reverseGroupingLabel=("reverseGroupingLabel"in propertyEntry)?propertyEntry.reverseGroupingLabel:property._reverseLabel;}
this._propertyArray=null;this._listeners.fire("onAfterLoadingProperties",[]);}catch(e){SimileAjax.Debug.exception("Database.loadProperties failed",e);}};Exhibit.Database.prototype.loadItems=function(itemEntries,baseURI){this._listeners.fire("onBeforeLoadingItems",[]);try{var lastChar=baseURI.substr(baseURI.length-1);if(lastChar=="#"){baseURI=baseURI.substr(0,baseURI.length-1)+"/";}else if(lastChar!="/"&&lastChar!=":"){baseURI+="/";}
var spo=this._spo;var ops=this._ops;var indexPut=Exhibit.Database._indexPut;var indexTriple=function(s,p,o){indexPut(spo,s,p,o);indexPut(ops,o,p,s);};for(var i=0;i<itemEntries.length;i++){var entry=itemEntries[i];if(entry!=null&&typeof entry!="undefined"){this._loadItem(entry,indexTriple,baseURI);}}
this._propertyArray=null;this._listeners.fire("onAfterLoadingItems",[]);}catch(e){SimileAjax.Debug.exception("Database.loadItems failed",e);}};Exhibit.Database.prototype.getType=function(typeID){return this._types[typeID];};Exhibit.Database.prototype.getProperty=function(propertyID){return propertyID in this._properties?this._properties[propertyID]:null;};Exhibit.Database.prototype.getAllProperties=function(){if(this._propertyArray==null){this._propertyArray=[];for(propertyID in this._properties){this._propertyArray.push(propertyID);}}
return[].concat(this._propertyArray);};Exhibit.Database.prototype.getAllItems=function(){var items=new Exhibit.Set();items.addSet(this._items);return items;};Exhibit.Database.prototype.getAllItemsCount=function(){return this._items.size();};Exhibit.Database.prototype.containsItem=function(itemID){return this._items.contains(itemID);};Exhibit.Database.prototype.getNamespaces=function(idToQualifiedName,prefixToBase){var bases={};for(propertyID in this._properties){var property=this._properties[propertyID];var uri=property.getURI();var hash=uri.indexOf("#");if(hash>0){var base=uri.substr(0,hash+1);bases[base]=true;idToQualifiedName[propertyID]={base:base,localName:uri.substr(hash+1)};continue;}
var slash=uri.lastIndexOf("/");if(slash>0){var base=uri.substr(0,slash+1);bases[base]=true;idToQualifiedName[propertyID]={base:base,localName:uri.substr(slash+1)};continue;}}
var baseToPrefix={};var letters="abcdefghijklmnopqrstuvwxyz";var i=0;for(base in bases){var prefix=letters.substr(i++,1);prefixToBase[prefix]=base;baseToPrefix[base]=prefix;}
for(propertyID in idToQualifiedName){var qname=idToQualifiedName[propertyID];qname.prefix=baseToPrefix[qname.base];}};Exhibit.Database.prototype._loadItem=function(itemEntry,indexFunction,baseURI){if(!("label"in itemEntry)&&!("id"in itemEntry)){SimileAjax.Debug.warn("Item entry has no label and no id: "+itemEntry);return;}
var id;if(!("label"in itemEntry)){id=itemEntry.id;if(!this._items.contains(id)){SimileAjax.Debug.warn("Cannot add new item containing no label: "+itemEntry);}}else{var label=itemEntry.label;var id=("id"in itemEntry)?itemEntry.id:label;var uri=("uri"in itemEntry)?itemEntry.uri:(baseURI+"item#"+encodeURIComponent(id));var type=("type"in itemEntry)?itemEntry.type:"Item";this._items.add(id);indexFunction(id,"uri",uri);indexFunction(id,"label",label);indexFunction(id,"type",type);this._ensureTypeExists(type,baseURI);}
for(p in itemEntry){if(p!="uri"&&p!="label"&&p!="id"&&p!="type"){this._ensurePropertyExists(p,baseURI)._onNewData();var v=itemEntry[p];if(v instanceof Array){for(var j=0;j<v.length;j++){indexFunction(id,p,v[j]);}}else{indexFunction(id,p,v);}}}};Exhibit.Database.prototype._ensureTypeExists=function(typeID,baseURI){if(!(typeID in this._types)){var type=new Exhibit.Database._Type(typeID);type._uri=baseURI+"type#"+encodeURIComponent(typeID);type._label=typeID;type._pluralLabel=type._label;this._types[typeID]=type;}};Exhibit.Database.prototype._ensurePropertyExists=function(propertyID,baseURI){if(!(propertyID in this._properties)){var property=new Exhibit.Database._Property(propertyID);property._uri=baseURI+"property#"+encodeURIComponent(propertyID);property._valueType="text";property._label=propertyID;property._pluralLabel=property._label;property._reverseLabel="reverse of "+property._label;property._reversePluralLabel="reverse of "+property._pluralLabel;property._groupingLabel=property._label;property._reverseGroupingLabel=property._reverseLabel;this._properties[propertyID]=property;return property;}else{return this._properties[propertyID];}};Exhibit.Database._indexPut=function(index,x,y,z){var hash=index[x];if(!hash){hash={};index[x]=hash;}
var array=hash[y];if(!array){array=new Array();hash[y]=array;}else{for(var i=0;i<array.length;i++){if(z==array[i]){return;}}}
array.push(z);};Exhibit.Database._indexPutList=function(index,x,y,list){var hash=index[x];if(!hash){hash={};index[x]=hash;}
var array=hash[y];if(!array){hash[y]=list;}else{hash[y]=hash[y].concat(list);}};Exhibit.Database.prototype._indexFillSet=function(index,x,y,set,filter){var hash=index[x];if(hash){var array=hash[y];if(array){if(filter){for(var i=0;i<array.length;i++){var z=array[i];if(filter.contains(z)){set.add(z);}}}else{for(var i=0;i<array.length;i++){set.add(array[i]);}}}}};Exhibit.Database.prototype._indexCountDistinct=function(index,x,y,filter){var count=0;var hash=index[x];if(hash){var array=hash[y];if(array){if(filter){for(var i=0;i<array.length;i++){if(filter.contains(array[i])){count++;}}}else{count=array.length;}}}
return count;};Exhibit.Database.prototype._get=function(index,x,y,set,filter){if(!set){set=new Exhibit.Set();}
this._indexFillSet(index,x,y,set,filter);return set;};Exhibit.Database.prototype._getUnion=function(index,xSet,y,set,filter){if(!set){set=new Exhibit.Set();}
var database=this;xSet.visit(function(x){database._indexFillSet(index,x,y,set,filter);});return set;};Exhibit.Database.prototype._countDistinctUnion=function(index,xSet,y,filter){var count=0;var database=this;xSet.visit(function(x){count+=database._indexCountDistinct(index,x,y,filter);});return count;};Exhibit.Database.prototype._countDistinct=function(index,x,y,filter){return this._indexCountDistinct(index,x,y,filter);};Exhibit.Database.prototype.getObjects=function(s,p,set,filter){return this._get(this._spo,s,p,set,filter);};Exhibit.Database.prototype.countDistinctObjects=function(s,p,filter){return this._countDistinct(this._spo,s,p,filter);};Exhibit.Database.prototype.getObjectsUnion=function(subjects,p,set,filter){return this._getUnion(this._spo,subjects,p,set,filter);};Exhibit.Database.prototype.countDistinctObjectsUnion=function(subjects,p,filter){return this._countDistinctUnion(this._spo,subjects,p,filter);};Exhibit.Database.prototype.getSubjects=function(o,p,set,filter){return this._get(this._ops,o,p,set,filter);};Exhibit.Database.prototype.countDistinctSubjects=function(o,p,filter){return this._countDistinct(this._ops,o,p,filter);};Exhibit.Database.prototype.getSubjectsUnion=function(objects,p,set,filter){return this._getUnion(this._ops,objects,p,set,filter);};Exhibit.Database.prototype.countDistinctSubjectsUnion=function(objects,p,filter){return this._countDistinctUnion(this._ops,objects,p,filter);};Exhibit.Database.prototype.getObject=function(s,p){var hash=this._spo[s];if(hash){var array=hash[p];if(array){return array[0];}}
return null;};Exhibit.Database.prototype.getSubject=function(o,p){var hash=this._ops[o];if(hash){var array=hash[p];if(array){return array[0];}}
return null;};Exhibit.Database.prototype.getSubjectsInRange=function(p,min,max,inclusive,set,filter){if(!set){set=new Exhibit.Set();}
var property=this.getProperty(p);if(property!=null){var rangeIndex=property.getRangeIndex();if(rangeIndex!=null){var f=(filter!=null)?function(item){if(filter.contains(item)){set.add(item);}}:function(item){set.add(item);};rangeIndex.getRange(f,min,max,inclusive);}}
return set;};Exhibit.Database.prototype.getTypeLabels=function(set){var typeIDSet=this.getObjectsUnion(set,"type",null,null);var labels=[];var pluralLabels=[];var database=this;typeIDSet.visit(function(typeID){var type=database.getType(typeID);if(type!=null){labels.push(type.getLabel());pluralLabels.push(type.getPluralLabel());}});return[labels,pluralLabels];};Exhibit.Database._Type=function(id){this._id=id;};Exhibit.Database._Type.prototype={getID:function(){return this._id;},getURI:function(){return this._uri;},getLabel:function(){return this._label;},getPluralLabel:function(){return this._pluralLabel;},getSuperTypeID:function(){return this._superTypeID;}};Exhibit.Database._Property=function(id,database){this._id=id;this._database=database;this._rangeIndex=null;};Exhibit.Database._Property.prototype={getID:function(){return this._id;},getURI:function(){return this._uri;},getValueType:function(){return this._valueType;},getLabel:function(){return this._label;},getPluralLabel:function(){return this._pluralLabel;},getReverseLabel:function(){return this._reverseLabel;},getReversePluralLabel:function(){return this._reversePluralLabel;},getGroupingLabel:function(){return this._groupingLabel;},getGroupingPluralLabel:function(){return this._groupingPluralLabel;}};Exhibit.Database._Property.prototype._onNewData=function(){this._rangeIndex=null;};Exhibit.Database._Property.prototype.getRangeIndex=function(){if(this._rangeIndex==null){this._buildRangeIndex();}
return this._rangeIndex;};Exhibit.Database._Property.prototype._buildRangeIndex=function(){var getter;var database=this._database;var p=this._id;switch(this.getValueType()){case"number":getter=function(item,f){database.getObjects(item,p,null,null).visit(function(value){if(typeof value!="number"){value=parseFloat(value);}
if(!isNaN(value)){f(value);}});};break;case"date":getter=function(item,f){database.getObjects(item,p,null,null).visit(function(value){if(value!=null&&!(value instanceof Date)){value=SimileAjax.DateTime.parseIso8601DateTime(value);}
if(value instanceof Date){f(value.getTime());}});};break;default:getter=function(item,f){};}
this._rangeIndex=new Exhibit.Database._RangeIndex(this._database.getAllItems(),getter);};Exhibit.Database._RangeIndex=function(items,getter){pairs=[];items.visit(function(item){getter(item,function(value){pairs.push({item:item,value:value});});});pairs.sort(function(p1,p2){var c=p1.value-p2.value;return c!=0?c:p1.item.localeCompare(p2.item);});this._pairs=pairs;};Exhibit.Database._RangeIndex.prototype.getCount=function(){return this._pairs.count();};Exhibit.Database._RangeIndex.prototype.getMin=function(){return this._pairs.length>0?this._pairs[0].value:Number.POSITIVE_INFINITY;};Exhibit.Database._RangeIndex.prototype.getMax=function(){return this._pairs.length>0?this._pairs[this._pairs.length-1].value:Number.NEGATIVE_INFINITY;};Exhibit.Database._RangeIndex.prototype.getRange=function(visitor,min,max,inclusive){var startIndex=this._indexOf(min);var pairs=this._pairs;var l=pairs.length;inclusive=(inclusive);while(startIndex<l){var pair=pairs[startIndex++];var value=pair.value;if(value<max||(value==max&&inclusive)){visitor(pair.item);}else{break;}}};Exhibit.Database._RangeIndex.prototype.countRange=function(min,max,inclusive){var startIndex=this._indexOf(min);var endIndex=this._indexOf(max);if(inclusive){var pairs=this._pairs;var l=pairs.length;while(endIndex<l){if(pairs[endIndex].value==max){endIndex++;}else{break;}}}
return endIndex-startIndex;};Exhibit.Database._RangeIndex.prototype._indexOf=function(v){var pairs=this._pairs;if(pairs.length==0||pairs[0]==v){return 0;}
var from=0;var to=pairs.length;while(from+1<to){var middle=(from+to)>>1;var v2=pairs[middle];if(v2>=v){to=middle;}else{from=middle;}}
return to;};

/* exhibit.js */

Exhibit.create=function(data,rootTypes){if(data==null){var urls=[];var heads=document.documentElement.getElementsByTagName("head");for(var h=0;h<heads.length;h++){var links=heads[h].getElementsByTagName("link");for(var l=0;l<links.length;l++){var link=links[l];if(link.rel=="exhibit/data"){urls.push(link.href);}}}
return Exhibit.createFromFiles(urls,rootTypes);}else{var exhibit=Exhibit._internalCreate({});if(!(data instanceof Array)){exhibit._dwim_create(data);}else{for(var i=0,specs;specs=data[i];i++){exhibit._dwim_create(specs);}}
exhibit.setRootTypes(rootTypes);return exhibit;}};Exhibit.createFromFiles=function(urls,rootTypes){var exhibit=Exhibit._internalCreate({});exhibit.loadJSON(urls,function(){exhibit.setRootTypes(rootTypes);});return exhibit;};Exhibit.createAdvanced=function(configuration,controlDiv,browseDiv,viewDiv){return Exhibit._internalCreate({controlDiv:controlDiv,browseDiv:browseDiv,viewDiv:viewDiv,configuration:configuration});};Exhibit.protectUI=function(elmt){SimileAjax.DOM.appendClassName(elmt,"exhibit-ui-protection");};Exhibit.getAttribute=function(elmt,name){try{var value=elmt.getAttribute(name);return(value!=null)?value:elmt.getAttribute("ex:"+name);}catch(e){return null;}};Exhibit.showHelp=function(message,url,target){target=(target)?target:"_blank";if(url!=null){if(window.confirm(message+"\n\n"+Exhibit.l10n.showDocumentationMessage)){window.open(url,target);}}else{window.alert(message);}};Exhibit.showJavascriptExpressionValidation=function(message,expression){var target="_blank";if(window.confirm(message+"\n\n"+Exhibit.l10n.showJavascriptValidationMessage)){window.open(Exhibit.validator+"?expresson="+encodeURIComponent(expression),target);}};Exhibit.showJsonFileValidation=function(message,url){var target="_blank";if(url.indexOf("file:")==0){if(window.confirm(message+"\n\n"+Exhibit.l10n.showJsonValidationFormMessage)){window.open(Exhibit.validator,target);}}else{if(window.confirm(message+"\n\n"+Exhibit.l10n.showJsonValidationMessage)){window.open(Exhibit.validator+"?url="+url,target);}}};Exhibit._internalCreate=function(settings){if(!("controlDiv"in settings)||settings.controlDiv==null){settings.controlDiv=document.getElementById("exhibit-control-panel");}
if(!("browseDiv"in settings)||settings.browseDiv==null){settings.browseDiv=document.getElementById("exhibit-browse-panel");}
if(!("viewDiv"in settings)||settings.viewDiv==null){settings.viewDiv=document.getElementById("exhibit-view-panel");}
if(!("configuration"in settings)||settings.configuration==null){settings.configuration={};}
return new Exhibit._Impl(settings.controlDiv,settings.browseDiv,settings.viewDiv,settings.configuration);};Exhibit.docRoot="http://simile.mit.edu/wiki/";Exhibit.validator="http://simile.mit.edu/babel/validator";Exhibit._Impl=function(controlDiv,browseDiv,viewDiv,configuration){this._configuration=configuration;this._exporters=[Exhibit.RdfXmlExporter,Exhibit.SemanticWikitextExporter,Exhibit.ExhibitJsonExporter,Exhibit.TSVExporter,Exhibit.HTMLExporter];if("exporters"in configuration){this._exporters=this._exporters.concat(configuration.exporters);}
this._database=new Exhibit.Database();this._engine=new Exhibit.BrowseEngine(this._database,configuration);this._controlPanel=new Exhibit.ControlPanel(this,controlDiv,configuration);this._browsePanel=new Exhibit.BrowsePanel(this,browseDiv,configuration);this._viewPanel=new Exhibit.ViewPanel(this,viewDiv,configuration);this._busyIndicator=Exhibit.Theme.createBusyIndicator();var self=this;this._focusID=null;this._databaseListener={onAfterLoadingItems:function(){self._tryToFocusOnItem();}};this._database.addListener(this._databaseListener);this._historyListener={onBeforePerform:function(action){if(action.lengthy){self._showBusyIndicator();}},onAfterPerform:function(action){if(action.lengthy){self._hideBusyIndicator();}},onBeforeUndoSeveral:function(){self._showBusyIndicator();},onAfterUndoSeveral:function(){self._hideBusyIndicator();},onBeforeRedoSeveral:function(){self._showBusyIndicator();},onAfterRedoSeveral:function(){self._hideBusyIndicator();}};SimileAjax.History.addListener(this._historyListener);this._parseURL();};Exhibit._Impl.prototype.getDatabase=function(){return this._database;};Exhibit._Impl.prototype.getBrowseEngine=function(){return this._engine;};Exhibit._Impl.prototype.getBrowsePanel=function(){return this._browsePanel;};Exhibit._Impl.prototype.getViewPanel=function(){return this._viewPanel;};Exhibit._Impl.prototype.getControlPanel=function(){return this._controlPanel;};Exhibit._Impl.prototype.dispose=function(){SimileAjax.History.removeListener(this._historyListener);this._database.removeListener(this._databaseListener);};Exhibit._Impl.prototype._dwim_create=function(data){var showError=function(){if(confirm("Exhibit.create() expects a Javascript object, the\n"+"ID of a <data> or <table> element, or an array of either.\n\n"+"Do you want to see to the relevant documentation?")){window.open("http://simile.mit.edu/wiki/Exhibit/Creating%2C_Importing%2C_and_Managing_Data","_blank");}};if(typeof data=="object")
return this.loadData(data);if(typeof data=="string"){var elmt=document.getElementById(data);if(elmt==null){return showError();}else{var tagName=elmt.tagName.toLowerCase();if(tagName=="data"){this.loadDataFromDomNode(elmt);}else if(tagName=="table"){this.loadDataFromTable(elmt);}else{showError();}}}else{showError();}}
Exhibit._Impl.prototype.setRootTypes=function(rootTypes){if(typeof rootTypes=="string"){this.getBrowseEngine().setRootCollection(this.getDatabase().getSubjects(rootTypes,"type"));}else if(rootTypes instanceof Array){this.getBrowseEngine().setRootCollection(this.getDatabase().getSubjectsUnion(new Exhibit.Set(rootTypes),"type"));}else{this.getBrowseEngine().setRootCollection(this.getDatabase().getAllItems());}};Exhibit._Impl.prototype.getPermanentLink=function(){var state={};var engineState=this._engine.getState();if(engineState!=null){state["browseEngine"]=engineState;}
var browsePanelState=this._browsePanel.getState();if(browsePanelState!=null){state["browsePanel"]=browsePanelState;}
var viewPanelState=this._viewPanel.getState();if(viewPanelState!=null){state["viewPanel"]=viewPanelState;}
var stateString=this._serializeState(state);return Exhibit._getURLWithoutQuery()+"?exhibit-state="+encodeURIComponent(stateString);};Exhibit._Impl.prototype.getItemLink=function(itemID){return Exhibit._getURLWithoutQueryAndHash()+"#"+encodeURIComponent(itemID);};Exhibit._Impl.prototype.loadJSON=function(urls,fDone){var exhibit=this;if(urls instanceof Array){urls=[].concat(urls);}else{urls=[urls];}
var fError=function(statusText,status,xmlhttp){Exhibit.showHelp(Exhibit.l10n.failedToLoadDataFileMessage(urls[0]));urls.shift();fNext();};var fDone2=function(xmlhttp){try{var o=null;var url=exhibit.resolveURL(urls[0]);try{o=eval("("+xmlhttp.responseText+")");}catch(e){Exhibit.showJsonFileValidation(Exhibit.l10n.badJsonMessage(url,e),url);}
if(o!=null){exhibit._loadJSON(o,exhibit.getBaseURL(urls[0]));}}catch(e){SimileAjax.Debug.exception("Exhibit: Error loading next JSON URL",e);}
urls.shift();fNext();};var fNext=function(){if(urls.length>0){SimileAjax.XmlHttp.get(urls[0],fError,fDone2);}else{try{if(fDone!=null){fDone();}else{var browseEngine=exhibit.getBrowseEngine();var database=exhibit.getDatabase();if(browseEngine.getCollectionCount()==0&&database.getAllItemsCount()>0){browseEngine.setRootCollection(database.getAllItems());}}}catch(e){SimileAjax.Debug.exception("Exhibit: Error loading next JSON URL",e);}finally{exhibit._hideBusyIndicator();}}};exhibit._showBusyIndicator();setTimeout(fNext,0);};Exhibit._Impl.prototype.loadJSONP=function(urls,fConvert,fDone){function attachJsonpCallbackName(url){if(url.indexOf("?")==-1)
url+="?";var lastChar=url.charAt(url.length-1);if(lastChar!="="){if(lastChar!='&'&&lastChar!="?")
url+="&";url+='callback=';}
return url;}
function copyObject(o){var clone={};for(var i in o){if(!o.hasOwnProperty(i))
continue;if(typeof o[i]=="object"){if(o[i]instanceof Array)
clone[i]=o[i].slice(0);else
clone[i]=arguments.callee(o[i]);}else{clone[i]=o[i];}}
return clone;}
var exhibit=this,feeds=[],converted=[],singleFeed=false;if(urls instanceof Array){urls=[].concat(urls);}else{singleFeed=true;urls=[urls];}
if(fConvert&&!(fConvert instanceof Array)){fConvert=[fConvert];for(var i=1;i<urls.length;i++){fConvert[i]=fConvert[0];}}
var beforeCount=exhibit.getDatabase().getAllItemsCount();var script;var next=Exhibit.callbacks.next||1;var callbackName="cb"+next.toString(36);Exhibit.callbacks.next=next+1;Exhibit.callbacks[callbackName]=function(json){var url=urls.shift();if(script&&script.parentNode)
script.parentNode.removeChild(script);if(fDone)
feeds.push(copyObject(json));if(fConvert)
json=fConvert.shift().call(exhibit,json,url);converted.push(json);try{exhibit._loadJSON(json,url);}catch(e){SimileAjax.Debug.exception("Exhibit: Error loading JSONP data from "+url,e);}
fNext();};var fNext=function(){if(urls.length){var url=attachJsonpCallbackName(urls[0])+"Exhibit.callbacks."+
callbackName;script=SimileAjax.includeJavascriptFile(document,url);}else{delete Exhibit.callbacks[callbackName];try{if(fDone){if(singleFeed)
fDone(feeds[0],converted[0]);else
fDone(feeds,converted);}else{var browseEngine=exhibit.getBrowseEngine();var database=exhibit.getDatabase();if(beforeCount==0&&database.getAllItemsCount()>0){browseEngine.setRootCollection(database.getAllItems());}}}catch(e){SimileAjax.Debug.exception("Exhibit: Error loading JSONP data",e);}finally{exhibit._hideBusyIndicator();}}};exhibit._showBusyIndicator();setTimeout(fNext,10);return Exhibit.callbacks[callbackName];};Exhibit._Impl.prototype.loadGoogleSpreadsheetsData=function(urls,fDone){if(typeof urls=="string")
urls=[urls];for(var i=0,url;url=urls[i];i++){urls[i]+="?alt=json-in-script";}
this.loadJSONP(urls,this._googleSpreadsheetsConverter,fDone);}
Exhibit._Impl.prototype.loadDataFromDomNode=function(node){window.alert("not yet implemented");};Exhibit._Impl.prototype.loadDataFromTable=function(table){var textOf=function(n){return n.textContent||n.innerText||"";};var readAttributes=function(node,attributes){var result={},found=false,attr,value,i;for(i=0;attr=attributes[i];i++){value=Exhibit.getAttribute(node,attr);if(value){result[attr]=value;found=true;}}
return found&&result;}
if(typeof table=="string")
table=document.getElementById(table);table.style.display="none";var typelist=["uri","label","pluralLabel"];var proplist=["uri","valueType","label","reverseLabel","pluralLabel","reversePluralLabel","groupingLabel","reverseGroupingLabel"];var columnProps=["valueParser","arity"];var parsed={};var type=Exhibit.getAttribute(table,'type');var types=type&&readAttributes(table,typelist);if(types){parsed.types={};parsed.types[type]=types;}
var fields=[],props={},columnData=[],row,col;var tr,trs=table.getElementsByTagName("tr");var th,ths=trs[0].getElementsByTagName("th");for(col=0;th=ths[col];col++){var field=textOf(th).trim();var attr=readAttributes(th,proplist);var name=Exhibit.getAttribute(th,'name');if(name){attr=attr||{};attr.label=attr.label||field;field=name;}
if(attr){props[field]=attr;parsed.properties=props;}
fields.push(field);attr=readAttributes(th,columnProps)||{};if(attr.valueParser&&attr.valueParser in window){attr.valueParser=window[attr.valueParser];}else{if(attr.arity=="single"){return function(text,node,rowNo,colNo){return text.trim();};}else{attr.valueParser=function(text,node,rowNo,colNo){if(text.indexOf(';')==-1)
return text.trim();var data=text.split(';');for(var i=0;i<data.length;i++)
data[i]=data[i].trim();return data;};}}
columnData[col]=attr;}
var img,imgs=table.getElementsByTagName("img");while(img=imgs[0])
img.parentNode.replaceChild(document.createTextNode(img.src),img);var items=[],td,raw;for(row=1;tr=trs[row];row++){var item={};var tds=tr.getElementsByTagName("td");for(col=0;td=tds[col];col++){var raw=textOf(td);data=columnData[col].valueParser(raw,td,row,col);if(data==null||raw===""){continue;}
if(typeof data=='object'&&!(data instanceof Array)){for(var property in data){item[property]=data[property];}}else{item[fields[col]]=data;}}
if(type)
item.type=type;items.push(item);parsed.items=items;}
return this.loadData(parsed);};Exhibit._Impl.prototype.loadData=function(data){this._loadJSON(data,Exhibit._getURLWithoutQueryAndHash());};Exhibit._Impl.prototype.getBaseURL=function(url){if(url.indexOf("://")<0){var url2=this.getBaseURL(document.location.href);if(url.substr(0,1)=="/"){url=url2.substr(0,url2.indexOf("/",url2.indexOf("://")+3))+url;}else{url=url2+url;}}
var i=url.lastIndexOf("/");if(i<0){return"";}else{return url.substr(0,i+1);}};Exhibit._Impl.prototype.resolveURL=function(url){if(url.indexOf("://")<0){var url2=this.getBaseURL(document.location.href);if(url.substr(0,1)=="/"){url=url2.substr(0,url2.indexOf("/",url2.indexOf("://")+3))+url;}else{url=url2+url;}}
return url;};Exhibit._Impl.prototype.makeActionLink=function(text,handler,layer){var a=document.createElement("a");a.href="javascript:";a.className="exhibit-action";a.innerHTML=text;var handler2=function(elmt,evt,target){if("true"==elmt.getAttribute("disabled")){SimileAjax.DOM.cancelEvent(evt);return false;}else{return handler(elmt,evt,target);}}
SimileAjax.WindowManager.registerEvent(a,"click",handler2,layer);return a;};Exhibit._Impl.prototype.makeActionLinkWithObject=function(text,obj,handlerName,layer){var a=document.createElement("a");a.href="javascript:";a.className="exhibit-action";a.innerHTML=text;var handler2=function(elmt,evt,target){if("true"==elmt.getAttribute("disabled")){SimileAjax.DOM.cancelEvent(evt);return false;}else{return obj[handlerName].call(obj,elmt,evt,target);}}
SimileAjax.WindowManager.registerEvent(a,"click",handler2,layer);return a;};Exhibit._Impl.prototype.enableActionLink=function(a,enabled){a.setAttribute("disabled",enabled?"false":"true");a.className=enabled?"exhibit-action":"exhibit-action-disabled";};Exhibit._Impl.prototype.makeItemSpan=function(itemID,label,layer){if(label==null){label=this._database.getObject(itemID,"label");}
if(label==null){label=itemID;}
var a=document.createElement("a");a.href=this.getItemLink(itemID);a.className="exhibit-item";a.innerHTML=label;var exhibit=this;var handler=function(elmt,evt,target){exhibit.showItemInPopup(itemID,elmt);SimileAjax.DOM.cancelEvent(evt);return false;}
SimileAjax.WindowManager.registerEvent(a,"click",handler,layer);return a;};Exhibit._Impl.prototype.makeValueSpan=function(label,valueType,layer){var span=document.createElement("span");span.className="exhibit-value";if(valueType=="url"){var a=document.createElement("a");a.target="_blank";a.href=label;if(label.length>50){a.innerHTML=label.substr(0,20)+" ... "+label.substr(label.length-20);}else{a.innerHTML=label;}
span.appendChild(a);}else{span.innerHTML=label;}
return span;};Exhibit._Impl.prototype.showItemInPopup=function(itemID,elmt){var coords=SimileAjax.DOM.getPageCoordinates(elmt);var bubble=SimileAjax.Graphics.createBubbleForPoint(document,coords.left+Math.round(elmt.offsetWidth/2),coords.top+Math.round(elmt.offsetHeight/2),400,300);var itemLensDiv=document.createElement("div");var itemLens=new Exhibit.Lens(itemID,itemLensDiv,this,this._configuration);bubble.content.appendChild(itemLensDiv);};Exhibit._Impl.prototype.makeCopyButton=function(itemID,layer){var self=this;var button=Exhibit.Theme.createCopyButton(itemID==null);var handler=function(elmt,evt,target){self._showCopyMenu(elmt,itemID);SimileAjax.DOM.cancelEvent(evt);return false;}
SimileAjax.WindowManager.registerEvent(button,"click",handler,layer!=null?layer:SimileAjax.WindowManager.getHighestLayer());return button;};Exhibit._Impl.prototype.getExporters=function(){return this._exporters;};Exhibit._Impl.prototype.addExporter=function(exporter){this._exporters.push(exporter);};Exhibit._Impl.prototype._loadJSON=function(o,url){if("types"in o){this._database.loadTypes(o.types,url);}
if("properties"in o){this._database.loadProperties(o.properties,url);}
if("items"in o){this._database.loadItems(o.items,url);}};Exhibit._Impl.prototype._googleSpreadsheetsConverter=function(json,url){var items=[];var properties={};var types={};var valueTypes={"text":true,"number":true,"item":true,"url":true,"boolean":true};var entries=json.feed.entry;for(var i=0;i<entries.length;i++){var entry=entries[i];var item={label:entry.title.$t};var fields=entry.content.$t;var openBrace=fields.indexOf("{");while(openBrace>=0){var closeBrace=fields.indexOf("}",openBrace+1);if(closeBrace<0){break;}
var fieldSpec=fields.substring(openBrace+1,closeBrace).trim().split(":");openBrace=fields.indexOf("{",closeBrace+1);var fieldValues=openBrace>0?fields.substring(closeBrace+1,openBrace):fields.substr(closeBrace+1);fieldValues=fieldValues.replace(/^\:\s+|,\s+$/g,"");var fieldName=fieldSpec[0].trim();var property=properties[fieldName];if(!(property)){var fieldDetails=fieldSpec.length>1?fieldSpec[1].split(","):[];property={};for(var d=0;d<fieldDetails.length;d++){var detail=fieldDetails[d].trim();var property={single:false};if(detail in valueTypes){property.valueType=detail;}else if(detail=="single"){property.single=true;}}
properties[fieldName]=property;}
if(!property.single){fieldValues=fieldValues.split(";");for(var v=0;v<fieldValues.length;v++){fieldValues[v]=fieldValues[v].trim();}}
item[fieldName]=fieldValues;}
items.push(item);}
return{types:types,properties:properties,items:items};};Exhibit._Impl.prototype._parseURL=function(){var params=SimileAjax.parseURLParameters(document.location.href);for(var i=0;i<params.length;i++){var p=params[i];if(p.name=="exhibit-state"){var state=this._deserializeState(p.value);if("browseEngine"in state){this._engine.setState(state["browseEngine"]);}
if("browsePanel"in state){this._browsePanel.setState(state["browsePanel"]);}
if("viewPanel"in state){this._viewPanel.setState(state["viewPanel"]);}}}
var hash=document.location.hash;if(hash.length>1){this._focusID=decodeURIComponent(hash.substr(1));}};Exhibit._Impl.prototype._tryToFocusOnItem=function(){if(this._focusID!=null&&this._database.containsItem(this._focusID)){var dom=Exhibit.Theme.createFocusDialogBox(this._focusID,this,this._configuration);dom.open();this._focusID=null;}};Exhibit._Impl.prototype._deserializeState=function(s){return eval(s);};Exhibit._Impl.prototype._serializeState=function(state){return Exhibit._anythingToJSON(state);};Exhibit._Impl.prototype._showCopyMenu=function(elmt,itemID){var exhibit=this;var popupDom=Exhibit.Theme.createPopupMenuDom(elmt);var makeMenuItem=function(exporter){popupDom.appendMenuItem(exporter.getLabel(),null,function(){var text=(itemID)?exporter.exportOne(itemID,exhibit):exporter.exportMany(exhibit.getBrowseEngine().getCurrentCollection().getCurrentSet(),exhibit);Exhibit.Theme.createCopyDialogBox(text).open();});}
var exporters=exhibit.getExporters();for(var i=0;i<exporters.length;i++){makeMenuItem(exporters[i]);}
popupDom.open();};Exhibit._Impl.prototype._showBusyIndicator=function(){var scrollTop=("scrollTop"in document.body)?document.body.scrollTop:document.body.parentNode.scrollTop;var height=("innerHeight"in window)?window.innerHeight:("clientHeight"in document.body?document.body.clientHeight:document.body.parentNode.clientHeight);var top=Math.floor(scrollTop+height/3);this._busyIndicator.style.top=top+"px";document.body.appendChild(this._busyIndicator);};Exhibit._Impl.prototype._hideBusyIndicator=function(){try{document.body.removeChild(this._busyIndicator);}catch(e){}};Exhibit._getURLWithoutQueryAndHash=function(){var url;if("_urlWithoutQueryAndHash"in Exhibit){url=Exhibit._urlWithoutQueryAndHash;}else{url=document.location.href;var hash=url.indexOf("#");var question=url.indexOf("?");if(hash>=0){url=url.substr(0,hash);}else if(question>=0){url=url.substr(0,question);}
Exhibit._urlWithoutQueryAndHash=url;}
return url;};Exhibit._getURLWithoutQuery=function(){var url;if("_urlWithoutQuery"in Exhibit){url=Exhibit._urlWithoutQuery;}else{url=document.location.href;var question=url.indexOf("?");if(question>=0){url=url.substr(0,question);}
Exhibit._urlWithoutQuery=url;}
return url;};Exhibit._anythingToJSON=function(x){if(typeof x=="string"){return'"'+x+'"';}else if(typeof x=="boolean"){return x?"true":"false";}else if(typeof x=="number"){return x.toString();}else if(typeof x=="object"){if(x instanceof Array){var s="[";for(var i=0;i<x.length;i++){if(i>0)s+=",";s+=Exhibit._anythingToJSON(x[i]);}
s+="]";return s;}else{var s="{";var first=true;for(m in x){if(first){first=false;}else{s+=",";}
s+=m+":"+Exhibit._anythingToJSON(x[m]);}
s+="}";return s;}}else if(x==null){return"null";}else{return"undefined";}};

/* bibtex-exporter.js */

Exhibit.BibtexExporter={getLabel:function(){return"Bibtex";},_excludeProperties:{"pub-type":true,"type":true,"uri":true,"key":true}};Exhibit.BibtexExporter.exportOne=function(itemID,exhibit){return Exhibit.BibtexExporter._wrap(Exhibit.BibtexExporter._exportOne(itemID,exhibit));};Exhibit.BibtexExporter.exportMany=function(set,exhibit){var s="";set.visit(function(itemID){s+=Exhibit.BibtexExporter._exportOne(itemID,exhibit)+"\n";});return Exhibit.BibtexExporter._wrap(s);};Exhibit.BibtexExporter._exportOne=function(itemID,exhibit){var s="";var database=exhibit.getDatabase();var type=database.getObject(itemID,"pub-type");var key=database.getObject(itemID,"key");s+="@"+type+"{"+(key!=null?key:itemID)+"\n";var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();if(values.size()>0&&!(propertyID in Exhibit.BibtexExporter._excludeProperties)){s+="\t"+(propertyID=="label"?"title":propertyID)+" = \"";var strings;if(valueType=="item"){strings=[];values.visit(function(value){strings.push(database.getObject(value,"label"));});}else{if(valueType=="url"){strings=[];values.visit(function(value){strings.push(exhibit.resolveURL(value));});}else{strings=values.toArray();}}
s+=strings.join(" and ")+"\",\n";}}
s+="\torigin = \""+exhibit.getItemLink(itemID)+"\"\n";s+="}\n";return s;};Exhibit.BibtexExporter._wrap=function(s){return s;}

/* exhibit-json-exporter.js */

Exhibit.ExhibitJsonExporter={getLabel:function(){return Exhibit.l10n.exhibitJsonExporterLabel;}};Exhibit.ExhibitJsonExporter.exportOne=function(itemID,exhibit){return Exhibit.ExhibitJsonExporter._wrap(Exhibit.ExhibitJsonExporter._exportOne(itemID,exhibit)+"\n");};Exhibit.ExhibitJsonExporter.exportMany=function(set,exhibit){var s="";var size=set.size();var count=0;set.visit(function(itemID){s+=Exhibit.ExhibitJsonExporter._exportOne(itemID,exhibit)+((count++<size-1)?",\n":"\n");});return Exhibit.ExhibitJsonExporter._wrap(s);};Exhibit.ExhibitJsonExporter._exportOne=function(itemID,exhibit){var s="";var database=exhibit.getDatabase();var uri=database.getObject(itemID,"uri");s+="\t\t{\tid: \""+itemID+"\",\n";var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();if(values.size()>0){var array;if(valueType=="url"){array=[];values.visit(function(value){array.push(exhibit.resolveURL(value));});}else{array=values.toArray();}
s+="\t\t\t"+propertyID+":\t";if(array.length==1){s+="\""+array[0]+"\"";}else{s+="[ ";for(var j=0;j<array.length;j++){s+=(j>0?", ":"")+"\""+array[j]+"\"";}
s+=" ]";}
s+=",\n";}}
s+="\t\t\torigin: \""+exhibit.getItemLink(itemID)+"\"\n";s+="\t\t}";return s;};Exhibit.ExhibitJsonExporter._wrap=function(s){return"{\n"+"\titems: [\n"+
s+"\t]\n"+"}";}

/* html-exporter.js */

Exhibit.HTMLExporter={getLabel:function(){return Exhibit.l10n.htmlExporterLabel;}};Exhibit.HTMLExporter.exportOne=function(itemID,exhibit){return Exhibit.HTMLExporter._getGeneratedViewHTML(exhibit);};Exhibit.HTMLExporter.exportMany=function(set,exhibit){return Exhibit.HTMLExporter._getGeneratedViewHTML(exhibit);};Exhibit.HTMLExporter._getGeneratedViewHTML=function(exhibit){return exhibit.getViewPanel().getGeneratedViewHTML().replace(/</g,"&lt;").replace(/>/g,"&gt;");};

/* rdf-xml-exporter.js */

Exhibit.RdfXmlExporter={getLabel:function(){return Exhibit.l10n.rdfXmlExporterLabel;}};Exhibit.RdfXmlExporter.exportOne=function(itemID,exhibit){var propertyIDToQualifiedName={};var prefixToBase={};exhibit.getDatabase().getNamespaces(propertyIDToQualifiedName,prefixToBase);return Exhibit.RdfXmlExporter._wrapRdf(Exhibit.RdfXmlExporter._exportOne(itemID,exhibit,propertyIDToQualifiedName,prefixToBase),prefixToBase);};Exhibit.RdfXmlExporter.exportMany=function(set,exhibit){var s="";var propertyIDToQualifiedName={};var prefixToBase={};exhibit.getDatabase().getNamespaces(propertyIDToQualifiedName,prefixToBase);set.visit(function(itemID){s+=Exhibit.RdfXmlExporter._exportOne(itemID,exhibit,propertyIDToQualifiedName,prefixToBase)+"\n";});return Exhibit.RdfXmlExporter._wrapRdf(s,prefixToBase);};Exhibit.RdfXmlExporter._exportOne=function(itemID,exhibit,propertyIDToQualifiedName,prefixToBase){var s="";var database=exhibit.getDatabase();var uri=database.getObject(itemID,"uri");s+="<rdf:Description rdf:about='"+uri+"'>\n"
var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();var propertyString;if(propertyID in propertyIDToQualifiedName){var qname=propertyIDToQualifiedName[propertyID];propertyString=qname.prefix+":"+qname.localName;}else{propertyString=property.getURI();}
if(valueType=="item"){values.visit(function(value){s+="\t<"+propertyString+" rdf:resource='"+value+"' />\n";});}else if(propertyID!="uri"){if(valueType=="url"){values.visit(function(value){s+="\t<"+propertyString+">"+exhibit.resolveURL(value)+"</"+propertyString+">\n";});}else{values.visit(function(value){s+="\t<"+propertyString+">"+value+"</"+propertyString+">\n";});}}}
s+="\t<exhibit:origin>"+exhibit.getItemLink(itemID)+"</exhibit:origin>\n";s+="</rdf:Description>";return s;};Exhibit.RdfXmlExporter._wrapRdf=function(s,prefixToBase){var s2="<?xml version='1.0'?>\n"+"<rdf:RDF xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns#'\n"+"\txmlns:exhibit='http://simile.mit.edu/2006/11/exhibit#'";for(prefix in prefixToBase){s2+="\n\txmlns:"+prefix+"='"+prefixToBase[prefix]+"'";}
s2+=">\n"+s+"\n</rdf:RDF>";return s2;}

/* semantic-wikitext-exporter.js */

Exhibit.SemanticWikitextExporter={getLabel:function(){return Exhibit.l10n.smwExporterLabel;}};Exhibit.SemanticWikitextExporter.exportOne=function(itemID,exhibit){return Exhibit.SemanticWikitextExporter._wrap(Exhibit.SemanticWikitextExporter._exportOne(itemID,exhibit));};Exhibit.SemanticWikitextExporter.exportMany=function(set,exhibit){var s="";set.visit(function(itemID){s+=Exhibit.SemanticWikitextExporter._exportOne(itemID,exhibit)+"\n";});return Exhibit.SemanticWikitextExporter._wrap(s);};Exhibit.SemanticWikitextExporter._exportOne=function(itemID,exhibit){var s="";var database=exhibit.getDatabase();var uri=database.getObject(itemID,"uri");s+=uri+"\n"
var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();if(valueType=="item"){values.visit(function(value){s+="[["+propertyID+"::"+value+"]]\n";});}else{if(valueType=="url"){values.visit(function(value){s+="[["+propertyID+":="+exhibit.resolveURL(value)+"]]\n";});}else{values.visit(function(value){s+="[["+propertyID+":="+value+"]]\n";});}}}
s+="[[origin:="+exhibit.getItemLink(itemID)+"]]\n";s+="\n";return s;};Exhibit.SemanticWikitextExporter._wrap=function(s){return s;}

/* tsv-exporter.js */

Exhibit.TSVExporter={getLabel:function(){return Exhibit.l10n.tsvExporterLabel;}};Exhibit.TSVExporter.exportOne=function(itemID,exhibit){return Exhibit.TSVExporter._wrap(Exhibit.TSVExporter._exportOne(itemID,exhibit),exhibit);};Exhibit.TSVExporter.exportMany=function(set,exhibit){var s="";set.visit(function(itemID){s+=Exhibit.TSVExporter._exportOne(itemID,exhibit)+"\n";});return Exhibit.TSVExporter._wrap(s,exhibit);};Exhibit.TSVExporter._exportOne=function(itemID,exhibit){var s="";var database=exhibit.getDatabase();var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var values=database.getObjects(itemID,propertyID);var valueType=property.getValueType();s+=values.toArray().join("; ")+"\t";}
return s;};Exhibit.TSVExporter._wrap=function(s,exhibit){var header="";var database=exhibit.getDatabase();var allProperties=database.getAllProperties();for(var i=0;i<allProperties.length;i++){var propertyID=allProperties[i];var property=database.getProperty(propertyID);var valueType=property.getValueType();header+=propertyID+":"+valueType+"\t";}
return header+"\n"+s;}

/* expression.js */

Exhibit.Expression=new Object();Exhibit.Expression.parse=function(s){var expressions=Exhibit.Expression.parseSeveral(s);if(expressions.length>1){throw new Error("Expected only one expression");}
return expressions[0];};Exhibit.Expression.parseSeveral=function(s){var tokens=Exhibit.Expression._tokenize(s);var x=-1;var token;var consumeToken=function(){++x;token=x<tokens.length?tokens[x]:null;};consumeToken();var parseFactor=function(){if(token==null){throw new Error("Missing factor");}
var result=null;switch(token.type){case Exhibit.Expression._Token.NUMBER:result=new Exhibit.Expression._Constant(token.value,"number");break;case Exhibit.Expression._Token.STRING:result=new Exhibit.Expression._Constant(token.value,"text");break;case Exhibit.Expression._Token.PATH:result=token.value;break;case Exhibit.Expression._Token.FUNCTION:var name=token.value;consumeToken();if(token.type==Exhibit.Expression._Token.DELIMITER&&token.value=="("){consumeToken();result=new Exhibit.Expression._FunctionCall(name,parseExpressionList());if(token==null||token.type!=Exhibit.Expression._Token.DELIMITER||token.value!=")"){throw new Error("Missing ) after function call");}}else{throw new Error("Missing ( after function name");}
break;case Exhibit.Expression._Token.CONTROL:var name=token.value;consumeToken();if(token.type==Exhibit.Expression._Token.DELIMITER&&token.value=="("){consumeToken();result=new Exhibit.Expression._ControlCall(name,parseExpressionList());if(token==null||token.type!=Exhibit.Expression._Token.DELIMITER||token.value!=")"){throw new Error("Missing ) to end "+name);}}else{throw new Error("Missing ( to start "+name);}
break;case Exhibit.Expression._Token.DELIMITER:if(token.value=="("){consumeToken();result=parseExpression();if(token==null||token.type!=Exhibit.Expression._Token.DELIMITER||token.value!=")"){throw new Error("Missing )");}
break;}
default:throw new Error("Unexpected token "+token);}
consumeToken();return result;};var parseTerm=function(){var term=parseFactor();while(token!=null&&token.type==Exhibit.Expression._Token.OPERATOR&&(token.value=="*"||token.value=="/")){var operator=token.value;consumeToken();term=new Exhibit.Expression._Operator(operator,[term,parseFactor()]);}
return term;};var parseSubExpression=function(){var subExpression=parseTerm();while(token!=null&&token.type==Exhibit.Expression._Token.OPERATOR&&(token.value=="+"||token.value=="-")){var operator=token.value;consumeToken();subExpression=new Exhibit.Expression._Operator(operator,[subExpression,parseTerm()]);}
return subExpression;};var parseExpression=function(){var expression=parseSubExpression();while(token!=null&&token.type==Exhibit.Expression._Token.OPERATOR&&(token.value=="="||token.value=="!="||token.value=="<"||token.value=="<="||token.value==">"||token.value==">=")){var operator=token.value;consumeToken();expression=new Exhibit.Expression._Operator(operator,[expression,parseSubExpression()]);}
return expression;};var parseExpressionList=function(){var expressions=[parseExpression()];while(token!=null&&token.type==Exhibit.Expression._Token.DELIMITER&&token.value==","){consumeToken();expressions.push(parseExpression());}
return expressions;}
var roots=parseExpressionList();if(token!=null){throw new Error("Extra text found at the end of the code");}
var expressions=[];for(var r=0;r<roots.length;r++){expressions.push(new Exhibit.Expression._Impl(roots[r]));}
return expressions;};Exhibit.Expression._delimiters={"(":true,")":true,",":true};Exhibit.Expression._tokenizeNoStringLiterals=function(s){s=s.replace(/\s+/g,' ').replace(/\s+\./g,'.').replace(/\s+\!/g,'!').replace(/\s?\(\s?/g,' ( ').replace(/\s?\)\s?/g,' ) ').replace(/\s\+\s/g,' + ').replace(/\s\-\s/g,' - ').replace(/\s\*\s/g,' * ').replace(/\s\/\s/g,' / ').replace(/\s?\,\s?/g,' , ').trim();var tokens=s.split(" ");var results=[];for(var i=0;i<tokens.length;i++){var token=tokens[i].trim();if(token==""){}else if(token in Exhibit.Expression._delimiters){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.DELIMITER,token));}else if(token in Exhibit.Expression._operators){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.OPERATOR,token));}else if(token in Exhibit.Functions){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.FUNCTION,token));}else if(token=="foreach"){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.CONTROL,token));}else{var n=parseFloat(token);if(isNaN(n)){results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.PATH,Exhibit.Expression._parsePath(token)));}else{results.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.NUMBER,n));}}}
return results;};Exhibit.Expression._tokenize=function(s){var tokens=[];var findClosingDelimiter=function(d){var start=0;while(start<s.length){var closing=s.indexOf(d,start);if(closing>0){if(s.substr(closing-1,1)=="\\"){start=closing+1;continue;}}
return closing;}
return-1;}
while(s.length>0){var delimiter="'";var opening=s.indexOf(delimiter);if(opening<0){delimiter='"';opening=s.indexOf(delimiter);}
if(opening<0){break;}else{tokens=tokens.concat(Exhibit.Expression._tokenizeNoStringLiterals(s.substr(0,opening)));s=s.substr(opening+1);var closing=findClosingDelimiter(delimiter);if(closing>=0){tokens.push(new Exhibit.Expression._Token(Exhibit.Expression._Token.STRING,s.substr(0,closing)));s=s.substr(closing+1);}else{throw new Error("String missing closing delimiter");}}}
if(s.length>0){tokens=tokens.concat(Exhibit.Expression._tokenizeNoStringLiterals(s));}
return tokens;};Exhibit.Expression._parsePath=function(s){var path=new Exhibit.Expression.Path();if(s.length>0){var dotBang=s.search(/[\.!]/);if(dotBang>0){path.setRootName(s.substr(0,dotBang));s=s.substr(dotBang);}else if(dotBang<0){path.setRootName(s);s="";}
var regex=/[\.!][^\.!]+/g;var result;while((result=regex.exec(s))!=null){var segment=result[0];var dotBang=segment.substr(0,1);var property=segment.substr(1);var isList=false;var at=property.indexOf("@");if(at>0){if(property.substr(at+1)=="list"){isList=true;}
property=property.substr(0,at);}
path.appendSegment(property,dotBang==".",isList);}}
return path;};Exhibit.Expression._Token=function(type,value){this.type=type;this.value=value;};Exhibit.Expression._Token.DELIMITER=0;Exhibit.Expression._Token.CONTROL=1;Exhibit.Expression._Token.PATH=2;Exhibit.Expression._Token.OPERATOR=3;Exhibit.Expression._Token.FUNCTION=4;Exhibit.Expression._Token.NUMBER=5;Exhibit.Expression._Token.STRING=6;Exhibit.Expression._Impl=function(rootNode){this._rootNode=rootNode;};Exhibit.Expression._Impl.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){return this._rootNode.evaluate(roots,rootValueTypes,defaultRootName,database);};Exhibit.Expression._Impl.prototype.evaluateSingle=function(roots,rootValueTypes,defaultRootName,database){var results=this._rootNode.evaluate(roots,rootValueTypes,defaultRootName,database);var result={value:null,valueType:results.valueType};results.values.visit(function(v){result.value=v;return true;});return result;};Exhibit.Expression._Impl.prototype.testExists=function(roots,rootValueTypes,defaultRootName,database){return this.isPath()?this._rootNode.testExists(roots,rootValueTypes,defaultRootName,database):false;};Exhibit.Expression._Impl.prototype.isPath=function(){return this._rootNode instanceof Exhibit.Expression.Path;};Exhibit.Expression._Impl.prototype.getPath=function(){return this.isPath()?this._rootNode:null;};Exhibit.Expression.Path=function(){this._rootName=null;this._segments=[];};Exhibit.Expression.Path.create=function(property,forward){var path=new Exhibit.Expression.Path();path._segments.push({property:property,forward:forward,isList:false});return path;};Exhibit.Expression.Path.prototype.setRootName=function(rootName){this._rootName=rootName;};Exhibit.Expression.Path.prototype.appendSegment=function(property,forward,isList){this._segments.push({property:property,forward:forward,isList:isList});};Exhibit.Expression.Path.prototype.getSegment=function(index){if(index<this._segments.length){var segment=this._segments[index];return{property:segment.property,forward:segment.forward};}else{return null;}};Exhibit.Expression.Path.prototype.getLastSegment=function(){return this.getSegment(this._segments.length-1);};Exhibit.Expression.Path.prototype.getSegmentCount=function(){return this._segments.length;};Exhibit.Expression.Path.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var rootName=this._rootName!=null?this._rootName:defaultRootName;var set=new Exhibit.Set();set.add(roots[rootName]);return this._walkForward(set,rootValueTypes[rootName],database);};Exhibit.Expression.Path.prototype.evaluateBackward=function(value,valueType,filter,database){var set=new Exhibit.Set();set.add(value);return this._walkBackward(set,valueType,filter,database);}
Exhibit.Expression.Path.prototype.walkForward=function(values,valueType,database){return this._walkForward(new Exhibit.Set(values),valueType,database);};Exhibit.Expression.Path.prototype.walkBackward=function(values,valueType,filter,database){return this._walkBackward(new Exhibit.Set(values),valueType,filter,database);};Exhibit.Expression.Path.prototype._walkForward=function(set,valueType,database){for(var i=0;i<this._segments.length;i++){var segment=this._segments[i];if(segment.forward){set=database.getObjectsUnion(set,segment.property);var property=database.getProperty(segment.property);valueType=property!=null?property.getValueType():"text";}else{set=database.getSubjectsUnion(set,segment.property);valueType="item";}}
return{valueType:valueType,values:set,count:set.size()};};Exhibit.Expression.Path.prototype._walkBackward=function(set,valueType,filter,database){for(var i=this._segments.length-1;i>=0;i--){var segment=this._segments[i];if(segment.forward){set=database.getSubjectsUnion(set,segment.property,null,i==0?filter:null);valueType="item";}else{set=database.getObjectsUnion(set,segment.property,i==0?filter:null);var property=database.getProperty(segment.property);valueType=property!=null?property.getValueType():"text";}}
return{valueType:valueType,values:set,count:set.size()};};Exhibit.Expression.Path.prototype.testExists=function(roots,rootValueTypes,defaultRootName,database){return this.evaluate(roots,rootValueTypes,defaultRootName,database).count>0;};Exhibit.Expression._Constant=function(value,valueType){this._value=value;this._valueType=valueType;};Exhibit.Expression._Constant.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var set=new Exhibit.Set();set.add(this._value);return{valueType:this._valueType,values:set,count:1};};Exhibit.Expression._Operator=function(operator,args){this._operator=operator;this._args=args;};Exhibit.Expression._Operator.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var set=new Exhibit.Set();var args=[];for(var i=0;i<this._args.length;i++){args.push(this._args[i].evaluate(roots,rootValueTypes,defaultRootName,database));}
var operator=Exhibit.Expression._operators[this._operator];var f=operator.f;if(operator.argumentType=="number"){args[0].values.visit(function(v1){if(!(typeof v1=="number")){v1=parseFloat(v1);}
args[1].values.visit(function(v2){if(!(typeof v2=="number")){v2=parseFloat(v2);}
set.add(f(v1,v2));});});}else{args[0].values.visit(function(v1){args[1].values.visit(function(v2){set.add(f(v1,v2));});});}
return{valueType:operator.valueType,values:set,count:set.size()};};Exhibit.Expression._operators={"+":{argumentType:"number",valueType:"number",f:function(a,b){return a+b;}},"-":{argumentType:"number",valueType:"number",f:function(a,b){return a-b;}},"*":{argumentType:"number",valueType:"number",f:function(a,b){return a*b;}},"/":{argumentType:"number",valueType:"number",f:function(a,b){return a/b;}},"=":{valueType:"boolean",f:function(a,b){return a==b;}},"<":{argumentType:"number",valueType:"boolean",f:function(a,b){return a<b;}},">":{argumentType:"number",valueType:"boolean",f:function(a,b){return a>b;}},"<=":{argumentType:"number",valueType:"boolean",f:function(a,b){return a<=b;}},">=":{argumentType:"number",valueType:"boolean",f:function(a,b){return a>=b;}}}
Exhibit.Expression._FunctionCall=function(name,args){this._name=name;this._args=args;};Exhibit.Expression._FunctionCall.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var args=[];for(var i=0;i<this._args.length;i++){args.push(this._args[i].evaluate(roots,rootValueTypes,defaultRootName,database));}
return Exhibit.Functions[this._name].f(args);};Exhibit.Expression._ControlCall=function(name,args){this._name=name;this._args=args;};Exhibit.Expression._ControlCall.prototype.evaluate=function(roots,rootValueTypes,defaultRootName,database){var self=this;if(this._name=="foreach"){var collection=this._args[0].evaluate(roots,rootValueTypes,defaultRootName,database);var oldValue=roots["value"];var oldValueType=rootValueTypes["value"];rootValueTypes["value"]=collection.valueType;var results=new Exhibit.Set();var valueType="text";collection.values.visit(function(element){roots["value"]=element;var r=self._args[1].evaluate(roots,rootValueTypes,defaultRootName,database);valueType=r.valueType;results.addSet(r.values);});roots["value"]=oldValue;rootValueTypes["value"]=oldValueType;return{valueType:valueType,values:results,count:results.size()};}
return{valueType:"text",values:new Exhibit.Set(),count:0};};

/* list-facet.js */

Exhibit.ListFacet=function(exhibit,facet,div,configuration){this._exhibit=exhibit;this._configuration=configuration;this._facetID=facet.facetID;this._facetLabel=facet.facetLabel;this._dom=null;this._topValueDoms=null;this._groupingBoxDom=null;this._constructFrame(div,facet);this.update(facet);};Exhibit.ListFacet.prototype.dispose=function(){this._dom.close();if(this._groupingBoxDom!=null){this._groupingBoxDom.elmt.parentNode.removeChild(this._groupingBoxDom.elmt);this._groupingBoxDom=null;}
this._exhibit=null;this._configuration=null;this._dom=null;this._topValueDoms=null;};Exhibit.ListFacet.prototype.update=function(facet){this._dom.valuesContainer.style.display="none";this._dom.valuesContainer.innerHTML="";this._constructBody(facet);this._dom.valuesContainer.style.display="block";};Exhibit.ListFacet.prototype._constructFrame=function(div,facet){var listFacet=this;var onGroup=function(elmt,evt,target){listFacet._openGroupingUI();SimileAjax.DOM.cancelEvent(evt);return false;};var onCollapseAll=function(elmt,evt,target){listFacet._collapseGroups();SimileAjax.DOM.cancelEvent(evt);return false;};var onExpandAll=function(elmt,evt,target){listFacet._expandGroups();SimileAjax.DOM.cancelEvent(evt);return false;};var onClearSelections=function(elmt,evt,target){listFacet._clearSelections();SimileAjax.DOM.cancelEvent(evt);return false;};this._dom=Exhibit.ListFacet.theme.constructFacetFrame(this._exhibit,div,facet.facetLabel,facet.groupable,facet.groupLevelCount>0,onGroup,onCollapseAll,onExpandAll,onClearSelections);this._dom.open();};Exhibit.ListFacet.prototype._constructBody=function(facet){var listFacet=this;this._topValueDoms=[];this._dom.setGroupControlsVisible(facet.groupLevelCount>0);var constructValue=function(value,containerDiv,level){var hasChildren=value.children.length>0;var expanded=false;var onSelect=function(elmt,evt,target){listFacet._filter(valueDom);SimileAjax.DOM.cancelEvent(evt);return false;};var valueDom=Exhibit.ListFacet.theme.constructFacetItem(listFacet._exhibit,value.label,value.count,level,value.selected,hasChildren,expanded,onSelect);valueDom.value=value.value;valueDom.selected=value.selected;valueDom.level=level;containerDiv.appendChild(valueDom.elmt);if(level==0){listFacet._topValueDoms.push(valueDom);}
if(value.children.length>0){var childrenContainer=Exhibit.ListFacet.theme.constructFacetChildrenContainer(listFacet._exhibit,expanded);constructValues(value.children,childrenContainer,level+1);containerDiv.appendChild(childrenContainer);valueDom.childrenContainer=childrenContainer;}};var constructValues=function(values,containerDiv,level){for(var j=0;j<values.length;j++){constructValue(values[j],containerDiv,level);}};constructValues(facet.values,this._dom.valuesContainer,0);this._groupLevelCount=facet.groupLevelCount;this._dom.setSelectionCount(facet.selectedCount);};Exhibit.ListFacet.prototype._filter=function(valueDom){var facetID=this._facetID;var level=this._groupLevelCount-valueDom.level-1;var value=valueDom.value;var selected=!valueDom.selected;var browseEngine=this._exhibit.getBrowseEngine();SimileAjax.History.addAction({perform:function(){browseEngine.setValueRestriction(facetID,level,value,selected);},undo:function(){browseEngine.setValueRestriction(facetID,level,value,!selected);},label:selected?("set "+this._facetLabel+" = "+value):("unset "+this._facetLabel+" = "+value),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.ListFacet.prototype._slide=function(){};Exhibit.ListFacet.prototype._clearSelections=function(){var state={};var facetID=this._facetID;var browseEngine=this._exhibit.getBrowseEngine();SimileAjax.History.addAction({perform:function(){state.restrictions=browseEngine.clearFacetRestrictions(facetID);},undo:function(){browseEngine.applyFacetRestrictions(facetID,state.restrictions);},label:"clear selections",uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.ListFacet.prototype._openGroupingUI=function(){if(this._groupingBoxDom!=null){return;}
var coords=SimileAjax.DOM.getPageCoordinates(this._dom.elmt);var listFacet=this;this._groupingBoxDom=Exhibit.ListFacet.theme.constructGroupingBox(this._exhibit,coords.left>(document.body.scrollWidth/2),function(elmt,evt,target){listFacet._ungroupAll();SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){listFacet._closeGroupingUI();SimileAjax.DOM.cancelEvent(evt);return false;});this._reconstructGroupingBox();this._dom.elmt.appendChild(this._groupingBoxDom.elmt);}
Exhibit.ListFacet.prototype._closeGroupingUI=function(){if(this._groupingBoxDom!=null){this._groupingBoxDom.elmt.parentNode.removeChild(this._groupingBoxDom.elmt);this._groupingBoxDom=null;}}
Exhibit.ListFacet.prototype._reconstructGroupingBox=function(){var listFacet=this;this._groupingBoxDom.clearGroups();var makeGroup=function(group,level){var groupDom=Exhibit.ListFacet.theme.constructGroup(listFacet._exhibit,level==0,group.grouped,function(elmt,evt,target){listFacet._ungroup(groupDom);SimileAjax.DOM.cancelEvent(evt);return false;});groupDom.level=level;listFacet._groupingBoxDom.appendGroup(groupDom);var makeGroupOption=function(groupingOption){var optionDom=Exhibit.ListFacet.theme.constructGroupingOption(listFacet._exhibit,groupingOption.label,groupingOption.selected,function(elmt,evt,target){listFacet._toggleGroup(groupDom,optionDom);SimileAjax.DOM.cancelEvent(evt);return false;});optionDom.property=groupingOption.property;optionDom.forward=groupingOption.forward;optionDom.selected=groupingOption.selected;groupDom.appendOption(optionDom);};var groupingOptions=group.groupingOptions;for(var j=0;j<groupingOptions.length;j++){makeGroupOption(groupingOptions[j]);}};var groups=this._exhibit.getBrowseEngine().getGroups(this._facetID);for(var i=0;i<groups.length;i++){makeGroup(groups[i],i);}}
Exhibit.ListFacet.prototype._toggleGroup=function(groupDom,optionDom){if(optionDom.selected){this._ungroup(groupDom);}else{this._group(groupDom,optionDom);}}
Exhibit.ListFacet.prototype._group=function(groupDom,optionDom){var property=optionDom.property;var forward=optionDom.forward;var selected=optionDom.selected;var level=groupDom.level;this._exhibit.getBrowseEngine().group(this._facetID,level,property,forward);this._reconstructGroupingBox();var facet=this._exhibit.getBrowseEngine().getFacet(this._facetID);if(facet!=null){this.update(facet);}}
Exhibit.ListFacet.prototype._ungroup=function(groupDom){this._exhibit.getBrowseEngine().ungroup(this._facetID,groupDom.level);this._reconstructGroupingBox();var facet=this._exhibit.getBrowseEngine().getFacet(this._facetID);if(facet!=null){this.update(facet);}}
Exhibit.ListFacet.prototype._ungroupAll=function(){this._exhibit.getBrowseEngine().ungroup(this._facetID,0);this._reconstructGroupingBox();var facet=this._exhibit.getBrowseEngine().getFacet(this._facetID);if(facet!=null){this.update(facet);}}
Exhibit.ListFacet.prototype._collapseGroups=function(){for(var i=0;i<this._topValueDoms.length;i++){this._topValueDoms[i].collapseGroup();}}
Exhibit.ListFacet.prototype._expandGroups=function(valueDom){for(var i=0;i<this._topValueDoms.length;i++){this._topValueDoms[i].expandGroup();}}

/* functions.js */

Exhibit.Functions={};Exhibit.Functions["union"]={f:function(args){var set=new Exhibit.Set();if(args.length==0){return{valueType:"text",values:set,count:0};}else{var valueType=args[0].valueType;set.addSet(args[0].values);for(var i=1;i<args.length;i++){var arg=args[i];if(valueType==arg.valueType){set.addSet(arg.values);}}
return{valueType:valueType,values:set,count:set.size()};}}};Exhibit.Functions["contains"]={f:function(args){var result=args[0].values.size()>0;args[1].values.visit(function(v){if(!args[0].values.contains(v)){result=false;}});var set=new Exhibit.Set();set.add(result);return{valueType:"boolean",values:set,count:set.size()};}};Exhibit.Functions["count"]={f:function(args){var set=new Exhibit.Set();set.add(args[0].values.size());return{valueType:"number",values:set,count:set.size()};}};Exhibit.Functions["add"]={f:function(args){var total=0;for(var i=0;i<args.length;i++){args[i].values.visit(function(v){if(v!=null){if(typeof v=="number"){total+=v;}else{var n=parseFloat(v);if(!isNaN(n)){total+=n;}}}});}
var set=new Exhibit.Set();set.add(total);return{valueType:"number",values:set,count:set.size()};}};Exhibit.Functions["multiply"]={f:function(args){var product=1;for(var i=0;i<args.length;i++){args[i].values.visit(function(v){if(v!=null){if(typeof v=="number"){product*=v;}else{var n=parseFloat(v);if(!isNaN(n)){product*=n;}}}});}
var set=new Exhibit.Set();set.add(total);return{valueType:"number",values:set,count:set.size()};}};Exhibit.Functions["date-range"]={_parseDate:function(v){if(v==null){return Number.NEGATIVE_INFINITY;}else if(v instanceof Date){return v.getTime();}else{try{return SimileAjax.DateTime.parseIso8601DateTime(v).getTime();}catch(e){return Number.NEGATIVE_INFINITY;}}},_factors:{second:1000,minute:60*1000,hour:60*60*1000,day:24*60*60*1000,week:7*24*60*60*1000,month:30*24*60*60*1000,quarter:3*30*24*60*60*1000,year:365*24*60*60*1000,decade:10*365*24*60*60*1000,century:100*365*24*60*60*1000},_computeRange:function(from,to,interval){var range=to-from;if(isFinite(range)){if(interval in this._factors){range=Math.round(range/this._factors[interval]);}
return range;}
return null;},f:function(args){var self=this;var from=Number.POSITIVE_INFINITY;args[0].values.visit(function(v){from=Math.min(from,self._parseDate(v));});var to=Number.NEGATIVE_INFINITY;args[1].values.visit(function(v){to=Math.max(to,self._parseDate(v));});var interval="day";args[2].values.visit(function(v){interval=v;});var set=new Exhibit.Set();var range=this._computeRange(from,to,interval);if(range!=null){set.add(range);}
return{valueType:"number",values:set,count:set.size()};}};

/* lens.js */

Exhibit.Lens=function(itemID,div,exhibit,configuration){var myConfig=("Lens"in configuration)?configuration["Lens"]:{};var lensTemplate=null;var lensSelector=myConfig["lensSelector"];if(lensSelector!=null){lensTemplate=lensSelector.call(null,itemID,exhibit);}
if(lensTemplate==null){this._constructDefaultUI(itemID,div,exhibit,myConfig);}else if(typeof lensTemplate=="string"){this._constructFromLensTemplateURL(itemID,div,exhibit,configuration,lensTemplate);}else{this._constructFromLensTemplateDOM(itemID,div,exhibit,configuration,lensTemplate);}};Exhibit.Lens._commonProperties=null;Exhibit.Lens.prototype._constructDefaultUI=function(itemID,div,exhibit,myConfig){var database=exhibit.getDatabase();var properties=null;if("properties"in myConfig){properties=myConfig.properties;}else{if(Exhibit.Lens._commonProperties==null){Exhibit.Lens._commonProperties=database.getAllProperties();}
properties=Exhibit.Lens._commonProperties;}
var label=database.getObject(itemID,"label");var template={elmt:div,className:"exhibit-lens",children:[{tag:"div",className:"exhibit-lens-title",title:label,children:[{elmt:exhibit.makeCopyButton(itemID),className:"exhibit-copyButton exhibit-lens-copyButton"},label+" (",{tag:"a",href:exhibit.getItemLink(itemID),target:"_blank",children:[Exhibit.l10n.itemLinkLabel]},")"]},{tag:"div",className:"exhibit-lens-body",children:[{tag:"table",className:"exhibit-lens-properties",field:"propertiesTable"}]}]};var dom=SimileAjax.DOM.createDOMFromTemplate(document,template);var pairs=Exhibit.ViewPanel.getPropertyValuesPairs(itemID,properties,database);for(var j=0;j<pairs.length;j++){var pair=pairs[j];var tr=dom.propertiesTable.insertRow(j);tr.className="exhibit-lens-property";var tdName=tr.insertCell(0);tdName.className="exhibit-lens-property-name";tdName.innerHTML=pair.propertyLabel+": ";var tdValues=tr.insertCell(1);tdValues.className="exhibit-lens-property-values";if(pair.valueType=="item"){for(var m=0;m<pair.values.length;m++){if(m>0){tdValues.appendChild(document.createTextNode(", "));}
tdValues.appendChild(exhibit.makeItemSpan(pair.values[m]));}}else{for(var m=0;m<pair.values.length;m++){if(m>0){tdValues.appendChild(document.createTextNode(", "));}
tdValues.appendChild(exhibit.makeValueSpan(pair.values[m],pair.valueType));}}}};Exhibit.Lens._compiledTemplates={};Exhibit.Lens._handlers=["onblur","onfocus","onkeydown","onkeypress","onkeyup","onmousedown","onmouseenter","onmouseleave","onmousemove","onmouseout","onmouseover","onmouseup","onclick","onresize","onscroll"];Exhibit.Lens.prototype._constructFromLensTemplateURL=function(itemID,div,exhibit,configuration,lensTemplateURL){var job={lens:this,itemID:itemID,div:div,exhibit:exhibit,configuration:configuration};var compiledTemplate=Exhibit.Lens._compiledTemplates[lensTemplateURL];if(compiledTemplate==null){Exhibit.Lens._startCompilingTemplate(lensTemplateURL,job);}else if(!compiledTemplate.compiled){compiledTemplate.jobs.push(job);}else{job.template=compiledTemplate;Exhibit.Lens._performConstructFromLensTemplateJob(job);}};Exhibit.Lens.prototype._constructFromLensTemplateDOM=function(itemID,div,exhibit,configuration,lensTemplateNode){var job={lens:this,itemID:itemID,div:div,exhibit:exhibit,configuration:configuration};var id=lensTemplateNode.id;if(id==null||id.length==0){id="exhibitlensTemplate"+Math.floor(Math.random()*10000);lensTemplateNode.id=id;}
var compiledTemplate=Exhibit.Lens._compiledTemplates[id];if(compiledTemplate==null){compiledTemplate={url:id,template:Exhibit.Lens._compileTemplate(lensTemplateNode,false),compiled:true,jobs:[]};Exhibit.Lens._compiledTemplates[id]=compiledTemplate;}
job.template=compiledTemplate;Exhibit.Lens._performConstructFromLensTemplateJob(job);};Exhibit.Lens._startCompilingTemplate=function(lensTemplateURL,job){var compiledTemplate={url:lensTemplateURL,template:null,compiled:false,jobs:[job]};Exhibit.Lens._compiledTemplates[lensTemplateURL]=compiledTemplate;var fError=function(statusText,status,xmlhttp){SimileAjax.Debug.log("Failed to load view template from "+lensTemplateURL+"\n"+statusText);};var fDone=function(xmlhttp){try{compiledTemplate.template=Exhibit.Lens._compileTemplate(xmlhttp.responseXML.documentElement,true);compiledTemplate.compiled=true;for(var i=0;i<compiledTemplate.jobs.length;i++){try{var job=compiledTemplate.jobs[i];job.template=compiledTemplate;Exhibit.Lens._performConstructFromLensTemplateJob(job);}catch(e){SimileAjax.Debug.exception("Lens: Error constructing lens template in job queue",e);}}
compiledTemplate.jobs=null;}catch(e){SimileAjax.Debug.exception("Lens: Error compiling lens template and processing template job queue",e);}};SimileAjax.XmlHttp.get(lensTemplateURL,fError,fDone);return compiledTemplate;};Exhibit.Lens._compileTemplate=function(rootNode,isXML){return Exhibit.Lens._processTemplateNode(rootNode,isXML);};Exhibit.Lens._processTemplateNode=function(node,isXML){if(node.nodeType==1){return Exhibit.Lens._processTemplateElement(node,isXML);}else{return node.nodeValue;}};Exhibit.Lens._processTemplateElement=function(elmt,isXML){var templateNode={tag:elmt.tagName,control:null,condition:null,content:null,contentAttributes:null,subcontentAttributes:null,attributes:[],styles:[],handlers:[],children:null};var attributes=elmt.attributes;for(var i=0;i<attributes.length;i++){var attribute=attributes[i];var name=attribute.nodeName;var value=attribute.nodeValue;if(value==null||typeof value!="string"||value.length==0||name=="contentEditable"){continue;}
if(name.length>3&&name.substr(0,3)=="ex:"){name=name.substr(3);if(name=="control"){templateNode.control=value;}else if(name=="content"){templateNode.content=Exhibit.Expression.parse(value);}else if(name=="if-exists"){templateNode.condition={test:"if-exists",expression:Exhibit.Expression.parse(value)};}else if(name=="if"){templateNode.condition={test:"if",expression:Exhibit.Expression.parse(value)};}else if(name=="select"){templateNode.condition={test:"select",expression:Exhibit.Expression.parse(value)};}else if(name=="case"){templateNode.condition={test:"case",value:value};}else{var x=name.indexOf("-content");if(x>0){if(templateNode.contentAttributes==null){templateNode.contentAttributes=[];}
templateNode.contentAttributes.push({name:name.substr(0,x),expression:Exhibit.Expression.parse(value)});}else{x=name.indexOf("-subcontent");if(x>0){if(templateNode.subcontentAttributes==null){templateNode.subcontentAttributes=[];}
templateNode.subcontentAttributes.push({name:name.substr(0,x),fragments:Exhibit.Lens._parseSubcontentAttribute(value)});}}}}else{if(name=="style"){Exhibit.Lens._processStyle(templateNode,value);}else if(name!="id"){if(name=="class"){if(SimileAjax.Platform.browser.isIE){name="className";}}else if(name=="cellspacing"){name="cellSpacing";}else if(name=="cellpadding"){name="cellPadding";}else if(name=="bgcolor"){name="bgColor";}
templateNode.attributes.push({name:name,value:value});}}}
if(!isXML&&SimileAjax.Platform.browser.isIE){var handlers=Exhibit.Lens._handlers;for(var h=0;h<handlers.length;h++){var handler=handlers[h];var code=elmt[handler];if(code!=null){templateNode.handlers.push({name:handler,code:code});}}}
var childNode=elmt.firstChild;if(childNode!=null){templateNode.children=[];while(childNode!=null){templateNode.children.push(Exhibit.Lens._processTemplateNode(childNode,isXML));childNode=childNode.nextSibling;}}
return templateNode;};Exhibit.Lens._processStyle=function(templateNode,styleValue){var styles=styleValue.split(";");for(var s=0;s<styles.length;s++){var pair=styles[s].split(":");if(pair.length>1){var n=pair[0].trim();var v=pair[1].trim();if(n=="float"){n=SimileAjax.Platform.browser.isIE?"styleFloat":"cssFloat";}else if(n=="-moz-opacity"){n="MozOpacity";}else{if(n.indexOf("-")>0){var segments=n.split("-");n=segments[0];for(var x=1;x<segments.length;x++){n+=segments[x].substr(0,1).toUpperCase()+segments[x].substr(1);}}}
templateNode.styles.push({name:n,value:v});}}};Exhibit.Lens._parseSubcontentAttribute=function(value){var fragments=[];var current=0;var open;while(current<value.length&&(open=value.indexOf("{{",current))>=0){var close=value.indexOf("}}",open);if(close<0){break;}
fragments.push(value.substring(current,open));fragments.push(Exhibit.Expression.parse(value.substring(open+2,close)));current=close+2;}
if(current<value.length){fragments.push(value.substr(current));}
return fragments;};Exhibit.Lens._performConstructFromLensTemplateJob=function(job){Exhibit.Lens._constructFromLensTemplateNode({"value":job.itemID},{"value":"item"},job.template.template,job.div,job.exhibit,job);var node=job.div.firstChild;var tagName=node.tagName;if(tagName=="span"){node.style.display="inline";}else{node.style.display="block";}};Exhibit.Lens._constructFromLensTemplateNode=function(roots,rootValueTypes,templateNode,parentElmt,exhibit,job){if(typeof templateNode=="string"){parentElmt.appendChild(document.createTextNode(templateNode));return;}
var database=exhibit.getDatabase();var children=templateNode.children;if(templateNode.condition!=null){if(templateNode.condition.test=="if-exists"){if(!templateNode.condition.expression.testExists(roots,rootValueTypes,"value",database)){return;}}else if(templateNode.condition.test=="if"){if(!templateNode.condition.expression.evaluate(roots,rootValueTypes,"value",database).values.contains(true)){return;}}else if(templateNode.condition.test=="select"){var values=templateNode.condition.expression.evaluate(roots,rootValueTypes,"value",database).values;if(children!=null){var lastChildTemplateNode=null;for(var c=0;c<children.length;c++){var childTemplateNode=children[c];if(childTemplateNode.condition!=null&&childTemplateNode.condition.test=="case"){if(values.contains(childTemplateNode.condition.value)){Exhibit.Lens._constructFromLensTemplateNode(roots,rootValueTypes,childTemplateNode,parentElmt,exhibit,job);return;}}else if(typeof childTemplateNode!="string"){lastChildTemplateNode=childTemplateNode;}}}
if(lastChildTemplateNode!=null){Exhibit.Lens._constructFromLensTemplateNode(roots,rootValueTypes,lastChildTemplateNode,parentElmt,exhibit,job);}
return;}}
var elmt=Exhibit.Lens._constructElmtWithAttributes(templateNode,parentElmt,database);if(templateNode.contentAttributes!=null){var contentAttributes=templateNode.contentAttributes;for(var i=0;i<contentAttributes.length;i++){var attribute=contentAttributes[i];var values=[];attribute.expression.evaluate(roots,rootValueTypes,"value",database).values.visit(function(v){values.push(v);});elmt.setAttribute(attribute.name,values.join(";"));}}
if(templateNode.subcontentAttributes!=null){var subcontentAttributes=templateNode.subcontentAttributes;for(var i=0;i<subcontentAttributes.length;i++){var attribute=subcontentAttributes[i];var fragments=attribute.fragments;var results="";for(var r=0;r<fragments.length;r++){var fragment=fragments[r];if(typeof fragment=="string"){results+=fragment;}else{results+=fragment.evaluateSingle(roots,rootValueTypes,"value",database).value;}}
elmt.setAttribute(attribute.name,results);}}
var handlers=templateNode.handlers;for(var h=0;h<handlers.length;h++){var handler=handlers[h];elmt[handler.name]=handler.code;}
if(templateNode.control!=null){switch(templateNode.control){case"copy-button":elmt.appendChild(exhibit.makeCopyButton(roots["value"]));break;case"edit-button":var button=Exhibit.Lens.theme.createEditButton();var handler=function(elmt,evt,target){Exhibit.Lens._showEditForm(job);SimileAjax.DOM.cancelEvent(evt);return false;}
SimileAjax.WindowManager.registerEvent(button,"click",handler,SimileAjax.WindowManager.getHighestLayer());elmt.appendChild(button);break;case"item-link":var a=document.createElement("a");a.innerHTML=Exhibit.l10n.itemLinkLabel;a.href=exhibit.getItemLink(roots["value"]);a.target="_blank";elmt.appendChild(a);}}else if(templateNode.content!=null){var results=templateNode.content.evaluate(roots,rootValueTypes,"value",database);if(children!=null){var rootValueTypes2={"value":results.valueType,"index":"number"};var index=1;var processOneValue=function(childValue){var roots2={"value":childValue,"index":index++};for(var i=0;i<children.length;i++){Exhibit.Lens._constructFromLensTemplateNode(roots2,rootValueTypes2,children[i],elmt,exhibit,job);}};if(results.values instanceof Array){for(var i=0;i<results.values.length;i++){processOneValue(results.values[i]);}}else{results.values.visit(processOneValue);}}else{Exhibit.Lens._constructDefaultValueList(results.values,results.valueType,elmt,exhibit);}}else if(children!=null){for(var i=0;i<children.length;i++){Exhibit.Lens._constructFromLensTemplateNode(roots,rootValueTypes,children[i],elmt,exhibit,job);}}};Exhibit.Lens._constructElmtWithAttributes=function(templateNode,parentElmt,database){var elmt;switch(templateNode.tag){case"tr":elmt=parentElmt.insertRow(parentElmt.rows.length);break;case"td":elmt=parentElmt.insertCell(parentElmt.cells.length);break;default:elmt=document.createElement(templateNode.tag);parentElmt.appendChild(elmt);}
var attributes=templateNode.attributes;for(var i=0;i<attributes.length;i++){var attribute=attributes[i];elmt.setAttribute(attribute.name,attribute.value);}
var styles=templateNode.styles;for(var i=0;i<styles.length;i++){var style=styles[i];elmt.style[style.name]=style.value;}
return elmt;};Exhibit.Lens._constructDefaultValueList=function(values,valueType,parentElmt,exhibit){var processOneValue=(valueType=="item")?function(value){addDelimiter();parentElmt.appendChild(exhibit.makeItemSpan(value));}:function(value){addDelimiter();parentElmt.appendChild(exhibit.makeValueSpan(value,valueType));};if(values instanceof Array){var addDelimiter=Exhibit.l10n.createListDelimiter(parentElmt,values.length);for(var i=0;i<values.length;i++){processOneValue(values[i]);}}else{var addDelimiter=Exhibit.l10n.createListDelimiter(parentElmt,values.size());values.visit(processOneValue);}
addDelimiter();};Exhibit.Lens._showEditForm=function(job){job.div.innerHTML="";Exhibit.Lens._constructEditFromLensTemplateNode(job.itemID,"item",job.template.template,job.div,job.exhibit,job);var node=job.div.firstChild;var tagName=node.tagName;if(tagName=="span"){node.style.display="inline";}else{node.style.display="block";}};Exhibit.Lens._constructEditFromLensTemplateNode=function(value,valueType,templateNode,parentElmt,exhibit,job){if(typeof templateNode=="string"){parentElmt.appendChild(document.createTextNode(templateNode));return;}
var database=exhibit.getDatabase();if(templateNode.condition!=null){if(templateNode.condition.test=="if-exists"){if(!templateNode.condition.expression.testExists({"value":value},{"value":valueType},"value",database)){return;}}}
var elmt=Exhibit.Lens._constructEditElmtWithAttributes(value,valueType,templateNode,parentElmt,database);if(templateNode.contentAttributes!=null){var contentAttributes=templateNode.contentAttributes;for(var i=0;i<contentAttributes.length;i++){var attribute=contentAttributes[i];var values=[];attribute.expression.evaluate({"value":value},{"value":valueType},"value",database).values.visit(function(v){values.push(v);});elmt.setAttribute(attribute.name,values.join(";"));}}
var handlers=templateNode.handlers;for(var h=0;h<handlers.length;h++){var handler=handlers[h];elmt[handler.name]=handler.code;}
var children=templateNode.children;if(templateNode.control!=null){switch(templateNode.control){case"copy-button":elmt.appendChild(exhibit.makeCopyButton(value));break;case"edit-button":var button=Exhibit.Lens.theme.createSaveButton();var handler=function(elmt,evt,target){Exhibit.Lens._saveEdit(job);SimileAjax.DOM.cancelEvent(evt);return false;}
SimileAjax.WindowManager.registerEvent(button,"click",handler,SimileAjax.WindowManager.getHighestLayer());elmt.appendChild(button);break;case"item-link":var a=document.createElement("a");a.innerHTML=Exhibit.l10n.itemLinkLabel;a.href=exhibit.getItemLink(value);a.target="_blank";elmt.appendChild(a);}}else if(templateNode.content!=null){var results=templateNode.content.evaluate({"value":value},{"value":valueType},"value",database);if(children!=null){var processOneValue=function(childValue){for(var i=0;i<children.length;i++){Exhibit.Lens._constructEditFromLensTemplateNode(childValue,results.valueType,children[i],elmt,exhibit,job);}};if(results.values instanceof Array){for(var i=0;i<results.values.length;i++){processOneValue(results.values[i]);}}else{results.values.visit(processOneValue);}}else{Exhibit.Lens._constructEditDefaultValueList(results.values,results.valueType,elmt,exhibit);}}else if(children!=null){for(var i=0;i<children.length;i++){Exhibit.Lens._constructEditFromLensTemplateNode(value,valueType,children[i],elmt,exhibit,job);}}};Exhibit.Lens._constructEditElmtWithAttributes=function(value,valueType,templateNode,parentElmt,database){var elmt;switch(templateNode.tag){case"tr":elmt=parentElmt.insertRow(parentElmt.rows.length);break;case"td":elmt=parentElmt.insertCell(parentElmt.cells.length);break;default:elmt=document.createElement(templateNode.tag);parentElmt.appendChild(elmt);}
var attributes=templateNode.attributes;for(var i=0;i<attributes.length;i++){var attribute=attributes[i];elmt.setAttribute(attribute.name,attribute.value);}
var styles=templateNode.styles;for(var i=0;i<styles.length;i++){var style=styles[i];elmt.style[style.name]=style.value;}
return elmt;};Exhibit.Lens._constructEditDefaultValueList=function(values,valueType,parentElmt,exhibit){var processOneValue=(valueType=="item")?function(value){addDelimiter();var text=document.createElement("input");text.type="text";text.value=value;parentElmt.appendChild(text);}:function(value){addDelimiter();var text=document.createElement("input");text.type="text";text.value=value;parentElmt.appendChild(text);};if(values instanceof Array){var addDelimiter=Exhibit.l10n.createListDelimiter(parentElmt,values.length);for(var i=0;i<values.length;i++){processOneValue(values[i]);}}else{var addDelimiter=Exhibit.l10n.createListDelimiter(parentElmt,values.size());values.visit(processOneValue);}
addDelimiter();};

/* set.js */

Exhibit.Set=function(a){this._hash={};this._count=0;if(a instanceof Array){for(var i=0;i<a.length;i++){this.add(a[i]);}}else if(a instanceof Exhibit.Set){this.addSet(a);}}
Exhibit.Set.prototype.add=function(o){if(!(o in this._hash)){this._hash[o]=true;this._count++;return true;}
return false;}
Exhibit.Set.prototype.addSet=function(set){for(o in set._hash){this.add(o);}}
Exhibit.Set.prototype.remove=function(o){if(o in this._hash){delete this._hash[o];this._count--;return true;}
return false;}
Exhibit.Set.prototype.removeSet=function(set){for(o in set._hash){this.remove(o);}}
Exhibit.Set.prototype.contains=function(o){return(o in this._hash);}
Exhibit.Set.prototype.size=function(){return this._count;}
Exhibit.Set.prototype.toArray=function(){var a=[];for(o in this._hash){a.push(o);}
return a;}
Exhibit.Set.prototype.visit=function(f){for(o in this._hash){if(f(o)==true){break;}}}

/* view-panel.js */

Exhibit.ViewPanel=function(exhibit,div,configuration){if(configuration==null){var o=Exhibit.getAttribute(div,"configuration");if(o!=null&&o.length>0){try{o=eval(o);if(typeof o=="object"){configuration=o;}else{SimileAjax.Debug.log("The ex:configuration attribute value in <div id=\"exhibit-view-panel\"> does not evaluate to an object");}}catch(e){SimileAjax.Debug.exception("The ex:configuration attribute value in <div id=\"exhibit-view-panel\"> is not a valid Javascript expression",e);}}}
this._exhibit=exhibit;this._div=div;this._configuration=configuration;this._viewConstructors=[];this._viewConfigs=[];this._viewLabels=[];this._viewTooltips=[];this._viewDomConfigs=[];this._viewIndex=0;if("ViewPanel"in configuration){var c=configuration.ViewPanel;if("views"in c){var views=c.views;for(var i=0;i<views.length;i++){var view=views[i];var constructor=null;var label=null;var tooltip=null;var config=null;if(typeof view=="function"){constructor=view;}else if("viewClass"in view){constructor=view.viewClass;if("label"in view){label=view.label;}
if("tooltip"in view){tooltip=view.tooltip;}
if("configuration"in view){config=view.configuration;}}else{Exhibit.showHelp(Exhibit.ViewPanel.l10n.missingViewClassMessage,Exhibit.docRoot+"Exhibit/Configuring_Views");continue;}
if(label==null){if("l10n"in constructor&&"viewLabel"in constructor.l10n){label=constructor.l10n.viewLabel;}else{label=""+constructor;}}
if(tooltip==null){if("l10n"in constructor&&"viewTooltip"in constructor.l10n){tooltip=constructor.l10n.viewTooltip;}else{tooltip=label;}}
this._viewConstructors.push(constructor);this._viewConfigs.push(config!=null?config:{});this._viewLabels.push(label);this._viewTooltips.push(tooltip);this._viewDomConfigs.push(null);}}
if("initialView"in c){this._viewIndex=Math.max(0,Math.min(c.initialView,this._viewConstructors.length-1));}}
var node=this._div.firstChild;while(node!=null){if(node.nodeType==1){node.style.display="none";var role=Exhibit.getAttribute(node,"role");if(role=="exhibit-view"){var viewClass=Exhibit.getAttribute(node,"viewClass");try{var constructor=eval(viewClass);if(typeof constructor=="function"){var label=Exhibit.getAttribute(node,"label");var tooltip=Exhibit.getAttribute(node,"title");var config=null;if(label==null){if("l10n"in constructor&&"viewLabel"in constructor.l10n){label=constructor.l10n.viewLabel;}else{label=""+constructor;}}
if(tooltip==null){if("l10n"in constructor&&"viewTooltip"in constructor.l10n){tooltip=constructor.l10n.viewTooltip;}else{tooltip=label;}}
var o=Exhibit.getAttribute(node,"configuration");if(o!=null){try{o=eval(o);if(typeof o=="object"){config=o;}}catch(e){}}
this._viewConstructors.push(constructor);this._viewConfigs.push(config!=null?config:{});this._viewLabels.push(label);this._viewTooltips.push(tooltip);this._viewDomConfigs.push(node);}else{Exhibit.showHelp(Exhibit.ViewPanel.l10n.viewClassNotFunctionMessage(viewClass),Exhibit.docRoot+"Exhibit/Configuring_Views");}}catch(e){Exhibit.showJavascriptExpressionValidation(Exhibit.ViewPanel.l10n.badViewClassMessage(viewClass),viewClass);}}}
node=node.nextSibling;}
Exhibit.ViewPanel.extractItemLensDomConfiguration(this._div,configuration);if(this._viewConstructors.length==0){this._viewConstructors.push(Exhibit.TileView);this._viewConfigs.push({});this._viewLabels.push(Exhibit.TileView.l10n.viewLabel);this._viewTooltips.push(Exhibit.TileView.l10n.viewTooltip);this._viewDomConfigs.push(null);}
this._view=null;this._initializeUI();}
Exhibit.ViewPanel.prototype.getState=function(){return null;};Exhibit.ViewPanel.prototype.setState=function(state){};Exhibit.ViewPanel.prototype.getGeneratedViewHTML=function(){return this._dom.getViewContainer().innerHTML;};Exhibit.ViewPanel.prototype._initializeUI=function(){var div=document.createElement("div");if(this._div.firstChild!=null){this._div.insertBefore(div,this._div.firstChild);}else{this._div.appendChild(div);}
var self=this;this._dom=Exhibit.ViewPanel.theme.constructDom(this._exhibit,this._div.firstChild,this._viewLabels,this._viewTooltips,function(index){self._selectView(index);});this._createView();};Exhibit.ViewPanel.prototype._createView=function(){if(this._view){this._view.dispose();}
var viewContainer=this._dom.getViewContainer();viewContainer.innerHTML="";var viewDiv=document.createElement("div");viewContainer.appendChild(viewDiv);this._view=new this._viewConstructors[this._viewIndex](this._exhibit,viewDiv,this._viewConfigs[this._viewIndex],this._viewDomConfigs[this._viewIndex],this._configuration);this._dom.setViewIndex(this._viewIndex);};Exhibit.ViewPanel.prototype._selectView=function(newIndex){var oldIndex=this._viewIndex;var self=this;SimileAjax.History.addAction({perform:function(){self._viewIndex=newIndex;self._createView();},undo:function(){self._viewIndex=oldIndex;self._createView();},label:Exhibit.ViewPanel.l10n.createSelectViewActionTitle(self._viewLabels[newIndex]),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.ViewPanel.prototype.resetBrowseQuery=function(){var state={};var browseEngine=this._exhibit.getBrowseEngine();SimileAjax.History.addAction({perform:function(){state.restrictions=browseEngine.clearRestrictions();},undo:function(){browseEngine.applyRestrictions(state.restrictions);},label:Exhibit.OrderedViewFrame.l10n.resetActionTitle,uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.ViewPanel.getPropertyValuesPairs=function(itemID,propertyEntries,database){var pairs=[];var enterPair=function(propertyID,forward){var property=database.getProperty(propertyID);var values=forward?database.getObjects(itemID,propertyID):database.getSubjects(itemID,propertyID);var count=values.size();if(count>0){var itemValues=property.getValueType()=="item";var pair={propertyLabel:forward?(count>1?property.getPluralLabel():property.getLabel()):(count>1?property.getReversePluralLabel():property.getReverseLabel()),valueType:property.getValueType(),values:[]};if(itemValues){values.visit(function(value){var label=database.getObject(value,"label");pair.values.push(label!=null?label:value);});}else{values.visit(function(value){pair.values.push(value);});}
pairs.push(pair);}};for(var i=0;i<propertyEntries.length;i++){var entry=propertyEntries[i];if(typeof entry=="string"){enterPair(entry,true);}else{enterPair(entry.property,entry.forward);}}
return pairs;};Exhibit.ViewPanel.extractItemLensDomConfiguration=function(parentNode,configuration){var defaultTemplate=null;var typeToTemplate=null;var node=parentNode.firstChild;while(node!=null){if(node.nodeType==1){var role=Exhibit.getAttribute(node,"role");if(role=="exhibit-lens"){var itemTypes=Exhibit.getAttribute(node,"itemTypes");var template=null;var url=Exhibit.getAttribute(node,"templateFile");if(url!=null&&url.length>0){template=url;}else{var id=Exhibit.getAttribute(node,"template");var elmt=document.getElementById(id);if(elmt!=null){template=elmt;}else{template=node;}}
if(template!=null){if(itemTypes==null){defaultTemplate=template;}else{if(typeToTemplate==null){typeToTemplate={};}
itemTypes=itemTypes.split(",");for(var i=0;i<itemTypes.length;i++){typeToTemplate[itemTypes[i].trim()]=template;}}}}}
node=node.nextSibling;}
if(typeToTemplate!=null){configuration["Lens"]={lensSelector:function(itemID,exhibit){var type=exhibit.getDatabase().getObject(itemID,"type");var template=typeToTemplate[type];return template!=null?template:defaultTemplate;}};}else if(defaultTemplate!=null){configuration["Lens"]={lensSelector:function(itemID,exhibit){return defaultTemplate;}};}};

/* map-view.js */

Exhibit.MapView=function(exhibit,div,configuration,domConfiguration,globalConfiguration){this._exhibit=exhibit;this._div=div;this._configuration=configuration;this._globalConfiguration=globalConfiguration;this._lensConfiguration={};if("Lens"in globalConfiguration){this._lensConfiguration["Lens"]=globalConfiguration["Lens"];}
if(domConfiguration!=null){Exhibit.ViewPanel.extractItemLensDomConfiguration(domConfiguration,this._lensConfiguration);}
if("lensSelector"in configuration){if(!("Lens"in this._lensConfiguration)){this._lensConfiguration["Lens"]={};}
this._lensConfiguration["Lens"].lensSelector=configuration.lensSelector;}
var getLatLng=null;try{var makeGetLatLng=function(s,mazExpression){var latlngExpression=Exhibit.Expression.parse(s);return function(itemID,database){var result={};var x=Exhibit.MapView.evaluateSingle(latlngExpression,itemID,database);if(x!=null){var a=x.split(",");if(a.length==2){result.lat=(typeof a[0]=="number")?a[0]:parseFloat(a[0]);result.lng=(typeof a[1]=="number")?a[1]:parseFloat(a[1]);}}
var z=mazExpression&&Exhibit.MapView.evaluateSingle(mazExpression,itemID,database);if(z!=null){z=parseInt(z,10);if(typeof z=="number")
result.maxAutoZoom=z;}
return result;};};var makeGetLatLng2=function(lat,lng,mazExpression){var latExpression=Exhibit.Expression.parse(lat);var lngExpression=Exhibit.Expression.parse(lng);return function(itemID,database){var result={};var lat=Exhibit.MapView.evaluateSingle(latExpression,itemID,database);var lng=Exhibit.MapView.evaluateSingle(lngExpression,itemID,database);if(lat!=null&&lng!=null){result.lat=(typeof lat=="number")?lat:parseFloat(lat);result.lng=(typeof lng=="number")?lng:parseFloat(lng);}
var z=mazExpression&&Exhibit.MapView.evaluateSingle(mazExpression,itemID,database);if(z!=null){z=parseInt(z,10);if(typeof z=="number")
result.maxAutoZoom=z;}
return result;}};if(domConfiguration!=null){var maxAZ=Exhibit.getAttribute(domConfiguration,"maxAutoZoom");if(maxAZ!=null&&maxAZ.length>0){maxAZ=Exhibit.Expression.parse(maxAZ);}else
maxAZ=null;var latlng=Exhibit.getAttribute(domConfiguration,"latlng");if(latlng!=null&&latlng.length>0){getLatLng=makeGetLatLng(latlng,maxAZ);}else{var lat=Exhibit.getAttribute(domConfiguration,"lat");var lng=Exhibit.getAttribute(domConfiguration,"lng");if(lat!=null&&lng!=null&&lat.length>0&&lng.length>0){getLatLng=makeGetLatLng2(lat,lng,maxAZ);}}}
if("latlng"in configuration){getLatLng=makeGetLatLng(configuration.latlng);}else if("lat"in configuration&&"lng"in configuration){getLatLng=makeGetLatLng2(configuration.lat,configuration.lng);}}catch(e){SimileAjax.Debug.exception("MapView: Error processing lat/lng configuration of map view",e);}
this._getLatLng=(getLatLng!=null)?getLatLng:function(itemID,database){return{};};var getMarkerKey=null;try{var makeGetMarker=function(s){var markerExpression=Exhibit.Expression.parse(s);return function(itemID,database){var key=Exhibit.MapView.evaluateSingle(markerExpression,itemID,database);return key!=null?key:"";};};if(domConfiguration!=null){var marker=Exhibit.getAttribute(domConfiguration,"marker");if(marker!=null&&marker.length>0){getMarkerKey=makeGetMarker(marker);}}
if("marker"in configuration){getMarkerKey=makeGetMarker(configuration.marker);}}catch(e){SimileAjax.Debug.exception("MapView: Error processing marker configuration of map view",e);}
this._getMarkerKey=(getMarkerKey!=null)?getMarkerKey:function(itemID,database){return"";};this._mapSettings={maxAutoZoom:18,size:"small",scaleControl:true,overviewControl:false,type:"normal"};if(domConfiguration!=null){var s=Exhibit.getAttribute(domConfiguration,"center");if(s!=null&&s.length>0){var a=s.split(",");if(a.length==2){a[0]=parseFloat(a[0]);a[1]=parseFloat(a[1]);if(typeof a[0]=="number"&&typeof a[1]=="number"){this._mapSettings.center=a;}}}
s=Exhibit.getAttribute(domConfiguration,"zoom");if(s!=null&&s.length>0){this._mapSettings.zoom=parseInt(s);}
s=Exhibit.getAttribute(domConfiguration,"size");if(s!=null&&s.length>0){this._mapSettings.size=s;}
s=Exhibit.getAttribute(domConfiguration,"scaleControl");if(s!=null&&s.length>0){this._mapSettings.scaleControl=(s=="true");}
s=Exhibit.getAttribute(domConfiguration,"overviewControl");if(s!=null&&s.length>0){this._mapSettings.overviewControl=(s=="true");}
s=Exhibit.getAttribute(domConfiguration,"type");if(s!=null&&s.length>0){this._mapSettings.type=s;}}
if("center"in configuration){this._mapSettings.center=this._configuration.center;}
if("zoom"in configuration){this._mapSettings.zoom=configuration.zoom;}
if("maxAutoZoom"in configuration){this._mapSettings.maxAutoZoom=configuration.maxAutoZoom;}
if("size"in configuration){this._mapSettings.size=configuration.size;}
if("scaleControl"in configuration){this._mapSettings.scaleControl=configuration.scaleControl;}
if("type"in configuration){this._mapSettings.type=configuration.type;}
this._latlngCache=new Object();this._markerKeyCache=new Object();this._markerCache=new Object();this._maxMarker=0;this._initializeUI();var view=this;this._listener={onChange:function(handlerName){if(handlerName!="onGroup"&&handlerName!="onUngroup"){view._reconstruct();}}};this._exhibit.getBrowseEngine().addListener(this._listener);};Exhibit.MapView._markers=[{color:"FF9000"},{color:"5D7CBA"},{color:"A97838"},{color:"8B9BBA"},{color:"FFC77F"},{color:"003EBA"},{color:"29447B"},{color:"543C1C"}];Exhibit.MapView._wildcardMarker={color:"888888"};Exhibit.MapView._mixMarker={color:"FFFFFF"};Exhibit.MapView.evaluateSingle=function(expression,itemID,database){return expression.evaluateSingle({"value":itemID},{"value":"item"},"value",database).value;}
Exhibit.MapView.lookupLatLng=function(set,addressExpressionString,outputProperty,outputTextArea,database,accuracy){if(accuracy==undefined){accuracy=4;}
var expression=Exhibit.Expression.parse(addressExpressionString);var jobs=[];set.visit(function(item){var address=Exhibit.MapView.evaluateSingle(expression,item,database);if(address!=null){jobs.push({item:item,address:address});}});var results=[];var geocoder=new GClientGeocoder();var cont=function(){if(jobs.length>0){var job=jobs.shift();geocoder.getLocations(job.address,function(json){if("Placemark"in json){json.Placemark.sort(function(p1,p2){return p2.AddressDetails.Accuracy-p1.AddressDetails.Accuracy;});}
if("Placemark"in json&&json.Placemark.length>0&&json.Placemark[0].AddressDetails.Accuracy>=accuracy){var coords=json.Placemark[0].Point.coordinates;var lat=coords[1];var lng=coords[0];results.push("\t{ id: '"+job.item+"', "+outputProperty+": '"+lat+","+lng+"' }");}else{var segments=job.address.split(",");if(segments.length==1){results.push("\t{ id: '"+job.item+"' }");}else{job.address=segments.slice(1).join(",").replace(/^\s+/,"");jobs.unshift(job);}}
cont();});}else{outputTextArea.value=results.join(",\n");}};cont();};Exhibit.MapView.prototype.dispose=function(){this._exhibit.getBrowseEngine().removeListener(this._listener);this._div.innerHTML="";this._dom.map=null;this._dom=null;this._div=null;this._exhibit=null;GUnload();};Exhibit.MapView.prototype._initializeUI=function(){var self=this;this._div.innerHTML="";this._dom=Exhibit.MapView.theme.constructDom(this._exhibit,this._div,function(elmt,evt,target){self._exhibit.getViewPanel().resetBrowseQuery();SimileAjax.DOM.cancelEvent(evt);return false;});var mapDiv=this._dom.getMapDiv();mapDiv.style.height="400px";if("constructMap"in this._configuration){this._dom.map=this._configuration.constructMap(mapDiv);}else{var settings=this._mapSettings;this._dom.map=new GMap2(mapDiv);this._dom.map.enableDoubleClickZoom();this._dom.map.enableContinuousZoom();var center=("center"in settings)?new GLatLng(settings.center[0],settings.center[1]):new GLatLng(20,0);var zoom=("zoom"in settings)?settings.zoom:2;this._dom.map.setCenter(center,zoom);this._dom.map.addControl(settings.size=="small"?new GSmallMapControl():new GLargeMapControl());if(settings.overviewControl){this._dom.map.addControl(new GOverviewMapControl);}
if(settings.scaleControl){this._dom.map.addControl(new GScaleControl());}
this._dom.map.addControl(new GMapTypeControl());switch(settings.type){case"normal":this._dom.map.setMapType(G_NORMAL_MAP);break;case"satellite":this._dom.map.setMapType(G_SATELLITE_MAP);break;case"hybrid":this._dom.map.setMapType(G_HYBRID_MAP);break;}}
this._reconstruct();};Exhibit.MapView.prototype._reconstruct=function(){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var collection=exhibit.getBrowseEngine().getCurrentCollection();var originalSize=0;var currentSize=0;var mappableSize=0;if(collection!=null){originalSize=collection.originalSize();var currentSet=collection.getCurrentSet();currentSize=currentSet.size();}
this._dom.map.clearOverlays();this._dom.clearLegend();if(currentSize>0){var locationToData={};currentSet.visit(function(itemID){var latlng;if(itemID in self._latlngCache){latlng=self._latlngCache[itemID];}else{latlng=self._getLatLng(itemID,database);self._latlngCache[itemID]=latlng;}
if("lat"in latlng&&"lng"in latlng){var markerKey;if(itemID in self._markerKeyCache){markerKey=self._markerKeyCache[itemID];}else{markerKey=self._getMarkerKey(itemID,database);self._markerKeyCache[itemID]=markerKey;}
var latlngKey=latlng.lat+","+latlng.lng;var locationData=locationToData[latlngKey];if(!(locationData)){locationData={latlng:latlng,items:[],markerKey:markerKey};locationToData[latlngKey]=locationData;}else if(locationData.markerKey!=markerKey){locationData.markerKey=null;}
locationData.items.push(itemID);mappableSize++;}});var usedKeys={};var shape=Exhibit.MapView._defaultMarkerShape;var bounds,maxAutoZoom=Infinity;var addMarkerAtLocation=function(locationData){var items=locationData.items;if(!bounds){bounds=new GLatLngBounds();}
var markerData;if(locationData.markerKey==null){markerData=Exhibit.MapView._mixMarker;}else{usedKeys[locationData.markerKey]=true;if(locationData.markerKey in self._markerCache){markerData=self._markerCache[locationData.markerKey];}else{markerData=Exhibit.MapView._markers[self._maxMarker];self._markerCache[locationData.markerKey]=markerData;self._maxMarker=(self._maxMarker+1)%Exhibit.MapView._markers.length;}}
var icon;if(items.length==1){if(!("icon"in markerData)){markerData.icon=Exhibit.MapView._makeIcon(shape,markerData.color,"space");}
icon=markerData.icon;}else{icon=Exhibit.MapView._makeIcon(shape,markerData.color,locationData.items.length>50?"...":locationData.items.length);}
var point=new GLatLng(locationData.latlng.lat,locationData.latlng.lng);var marker=new GMarker(point,icon);if(maxAutoZoom>locationData.latlng.maxAutoZoom)
maxAutoZoom=locationData.latlng.maxAutoZoom;bounds.extend(point);GEvent.addListener(marker,"click",function(){self._dom.map.openInfoWindow(marker.getPoint(),self._createInfoWindow(items));});self._dom.map.addOverlay(marker);}
for(latlngKey in locationToData){addMarkerAtLocation(locationToData[latlngKey]);}
if(bounds&&typeof this._mapSettings.zoom=="undefined"){var zoom=Math.max(0,self._dom.map.getBoundsZoomLevel(bounds)-1);zoom=Math.min(zoom,maxAutoZoom,this._mapSettings.maxAutoZoom);self._dom.map.setZoom(zoom);}
if(bounds&&typeof this._mapSettings.center=="undefined")
self._dom.map.setCenter(bounds.getCenter());var legendLabels=[];var legendIcons=[];var shape=Exhibit.MapView._defaultMarkerShape;for(markerKey in this._markerCache){if(markerKey in usedKeys){var markerData=this._markerCache[markerKey];legendLabels.push(markerKey);legendIcons.push(Exhibit.MapView._markerUrlPrefix+
[shape,markerData.color,["m",shape,markerData.color,"legend.png"].join("-")].join("/"));}}
legendLabels.push(Exhibit.MapView.l10n.mixedLegendKey);legendIcons.push(Exhibit.MapView._markerUrlPrefix+
[shape,"FFFFFF",["m",shape,"FFFFFF","legend.png"].join("-")].join("/"));this._dom.addLegendBlock(Exhibit.MapView.theme.constructLegendBlockDom(this._exhibit,Exhibit.MapView.l10n.colorLegendTitle,legendIcons,legendLabels));this._dom.setTypes(database.getTypeLabels(currentSet)[currentSize>1?1:0]);}
this._dom.setCounts(currentSize,mappableSize,originalSize);};Exhibit.MapView.prototype._createInfoWindow=function(items){if(items.length>1){var ul=document.createElement("ul");for(var i=0;i<items.length;i++){var li=document.createElement("li");li.appendChild(this._exhibit.makeItemSpan(items[i]));ul.appendChild(li);}
return ul;}else{var itemLensDiv=document.createElement("div");var itemLens=new Exhibit.Lens(items[0],itemLensDiv,this._exhibit,this._lensConfiguration);return itemLensDiv;}};Exhibit.MapView._iconData=null;Exhibit.MapView._markerUrlPrefix="http://static.simile.mit.edu/graphics/maps/markers/";Exhibit.MapView._defaultMarkerShape="square";Exhibit.MapView._makeIcon=function(shape,color,label){if(Exhibit.MapView._iconData==null){Exhibit.MapView._iconData={iconSize:new GSize(40,35),iconAnchor:new GPoint(20,35),shadowSize:new GSize(55,40),infoWindowAnchor:new GPoint(19,1),imageMap:[6,0,6,22,15,22,20,34,25,25,34,22,34,0]};}
var data=Exhibit.MapView._iconData;var icon=new GIcon(G_DEFAULT_ICON);icon.image=Exhibit.MapView._markerUrlPrefix+
[shape,color,["m",shape,color,label+".png"].join("-")].join("/");icon.shadow=Exhibit.MapView._markerUrlPrefix+["m",shape,"shadow.png"].join("-");icon.iconSize=data.iconSize;icon.iconAnchor=data.iconAnchor;icon.imageMap=data.imageMap;icon.shadowSize=data.shadowSize;icon.infoWindowAnchor=data.infoWindowAnchor;return icon;};

/* ordered-view-frame.js */

Exhibit.OrderedViewFrame=function(exhibit,divHeader,divFooter,configuration,domConfiguration){this._exhibit=exhibit;this._divHeader=divHeader;this._divFooter=divFooter;this._orders=null;this._possibleOrders=null;this._initialCount=10;this._showAll=false;this._grouped=true;this._showDuplicates=false;if(domConfiguration!=null){var orders=Exhibit.getAttribute(domConfiguration,"orders");if(orders!=null&&orders.length>0){this._orders=[];this._configureOrders(orders.split(","));}
var directions=Exhibit.getAttribute(domConfiguration,"directions");if(directions!=null&&directions.length>0){directions=directions.split(",");for(var i=0;i<directions.length&&i<this._orders.length;i++){this._orders[i].ascending=(directions[i].trim().toLowerCase()!="descending");}}
var possibleOrders=Exhibit.getAttribute(domConfiguration,"possibleOrders");if(possibleOrders!=null&&possibleOrders.length>0){this._possibleOrders=[];this._configurePossibleOrders(possibleOrders.split(","));}
var possibleDirections=Exhibit.getAttribute(domConfiguration,"possibleDirections");if(possibleDirections!=null&&possibleDirections.length>0){possibleDirections=possibleDirections.split(",");for(var i=0;i<possibleDirections.length&&i<this._possibleOrders.length;i++){this._possibleOrders.ascending=(possibleDirections[i].trim().toLowerCase()!="descending");}}
var initialCount=Exhibit.getAttribute(domConfiguration,"initialCount");if(initialCount!=null&&initialCount.length>0){this._initialCount=parseInt(initialCount);}
var showAll=Exhibit.getAttribute(domConfiguration,"showAll");if(showAll!=null&&showAll.length>0){this._showAll=(showAll=="true");}
var grouped=Exhibit.getAttribute(domConfiguration,"grouped");if(grouped!=null&&grouped.length>0){this._grouped=(grouped=="true");}
var showDuplicates=Exhibit.getAttribute(domConfiguration,"showDuplicates");if(showDuplicates!=null&&showDuplicates.length>0){this._showDuplicates=(showDuplicates=="true");}}
if("orders"in configuration){this._orders=[];this._configureOrders(configuration.orders);}
if("possibleOrders"in configuration){this._possibleOrders=[];this._configurePossibleOrders(configuration.possibleOrders);}
if("initialCount"in configuration){this._initialCount=configuration.initialCount;}
if("showAll"in configuration){this._showAll=configuration.showAll;}
if("grouped"in configuration){this._grouped=configuration.grouped;}
if("showDuplicates"in configuration){this._showDuplicates=configuration.showDuplicates;}
if(this._possibleOrders==null){this._possibleOrders=[{property:"label",forward:true,ascending:true}];}
if(this._orders==null){this._orders=[this._possibleOrders[0]];}
this._initializeUI();};Exhibit.OrderedViewFrame.prototype.dispose=function(){this._headerDom=null;this._footerDom=null;this._divHeader.innerHTML="";this._divFooter.innerHTML="";this._divHeader=null;this._divFooter=null;this._exhibit=null;};Exhibit.OrderedViewFrame.prototype._configureOrders=function(orders){for(var i=0;i<orders.length;i++){var order=orders[i];var expr;var ascending=true;if(typeof order=="string"){expr=order;}else{expr=order.expression,ascending=("ascending"in order)?(order.ascending):true;}
var expression=Exhibit.Expression.parse(expr);if(expression.isPath()){var path=expression.getPath();if(path.getSegmentCount()==1){var segment=path.getSegment(0);this._orders.push({property:segment.property,forward:segment.forward,ascending:ascending});}}}};Exhibit.OrderedViewFrame.prototype._configurePossibleOrders=function(possibleOrders){var hasLabel=false;for(var i=0;i<possibleOrders.length;i++){var order=possibleOrders[i];var expr;var ascending=true;if(typeof order=="string"){expr=order;}else{expr=order.expression,ascending=("ascending"in order)?(order.ascending):true;}
var expression=Exhibit.Expression.parse(expr);if(expression.isPath()){var path=expression.getPath();if(path.getSegmentCount()==1){var segment=path.getSegment(0);this._possibleOrders.push({property:segment.property,forward:segment.forward,ascending:ascending});if(segment.property=="label"&&segment.forward){hasLabel=true;}}}}
if(!hasLabel){this._possibleOrders.push({property:"label",forward:true,ascending:true});}};Exhibit.OrderedViewFrame.prototype._initializeUI=function(){this._divHeader.innerHTML="";this._divFooter.innerHTML="";var self=this;this._headerDom=Exhibit.OrderedViewFrame.theme.createHeaderDom(this._exhibit,this._divHeader,function(elmt,evt,target){self._exhibit.getViewPanel().resetBrowseQuery();SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._openSortPopup(elmt,-1);SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._toggleGroup();SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._toggleShowDuplicates();SimileAjax.DOM.cancelEvent(evt);return false;});this._footerDom=Exhibit.OrderedViewFrame.theme.createFooterDom(this._exhibit,this._divFooter,function(elmt,evt,target){self._setShowAll(true);SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._setShowAll(false);SimileAjax.DOM.cancelEvent(evt);return false;});};Exhibit.OrderedViewFrame.prototype.reconstruct=function(){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var collection=exhibit.getBrowseEngine().getCurrentCollection();var currentSet;var originalSize=0;var currentSize=0;if(collection!=null){originalSize=collection.originalSize();currentSet=new Exhibit.Set(collection.getCurrentSet());currentSize=currentSet.size();}
this._headerDom.setCounts(currentSize,originalSize);this._headerDom.setGrouped(this._grouped);this._headerDom.setShowDuplicates(this._showDuplicates);var hasSomeGrouping=false;if(currentSize>0){this._headerDom.setTypes(database.getTypeLabels(currentSet)[currentSize>1?1:0]);hasSomeGrouping=this._internalReconstruct(currentSet);var orderDoms=[];var buildOrderDom=function(order,index){var property=database.getProperty(order.property);var orderDom=Exhibit.OrderedViewFrame.theme.createOrderDom(exhibit,(order.forward)?property.getPluralLabel():property.getReversePluralLabel(),function(elmt,evt,target){self._openSortPopup(elmt,index);SimileAjax.DOM.cancelEvent(evt);return false;});orderDoms.push(orderDom);};for(var i=0;i<this._orders.length;i++){buildOrderDom(this._orders[i],i);}
this._headerDom.setOrders(orderDoms);this._headerDom.enableThenByAction(orderDoms.length<this._possibleOrders.length);}
this._footerDom.setCounts(currentSize,this._initialCount,this._showAll,!(hasSomeGrouping&&this._grouped));};Exhibit.OrderedViewFrame.prototype._internalReconstruct=function(allItems){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var orders=this._orders;var itemIndex=0;var hasSomeGrouping=false;var createItem=function(itemID){if((hasSomeGrouping&&self._grouped)||self._showAll||itemIndex<self._initialCount){self.onNewItem(itemID,itemIndex++);}};var createGroup=function(label,valueType,index){if((hasSomeGrouping&&self._grouped)||self._showAll||itemIndex<self._initialCount){self.onNewGroup(label,valueType,index);}};var processLevel=function(items,index){var order=orders[index];var values=order.forward?database.getObjectsUnion(items,order.property):database.getSubjectsUnion(items,order.property);var valueType="text";if(order.forward){var property=database.getProperty(order.property);valueType=property!=null?property.getValueType():"text";}else{valueType="item";}
var keys=(valueType=="item"||valueType=="text")?processNonNumericLevel(items,index,values,valueType):processNumericLevel(items,index,values,valueType);var grouped=false;for(var k=0;k<keys.length;k++){if(keys[k].items.size()>1){grouped=true;}}
if(grouped){hasSomeGrouping=true;}
for(var k=0;k<keys.length;k++){var key=keys[k];if(key.items.size()>0){if(grouped&&self._grouped){createGroup(key.display,valueType,index);}
items.removeSet(key.items);if(key.items.size()>1&&index<orders.length-1){processLevel(key.items,index+1);}else{key.items.visit(createItem);}}}
if(items.size()>0){if(grouped&&self._grouped){createGroup(Exhibit.l10n.missingSortKey,valueType,index);}
if(items.size()>1&&index<orders.length-1){processLevel(items,index+1);}else{items.visit(createItem);}}};var processNonNumericLevel=function(items,index,values,valueType){var keys=[];var compareKeys;var retrieveItems;var order=orders[index];if(valueType=="item"){values.visit(function(itemID){var label=database.getObject(itemID,"label");label=label!=null?label:itemID;keys.push({itemID:itemID,display:label});});compareKeys=function(key1,key2){var c=key1.display.localeCompare(key2.display);return c!=0?c:key1.itemID.localeCompare(key2.itemID);};retrieveItems=order.forward?function(key){return database.getSubjects(key.itemID,order.property,null,items);}:function(key){return database.getObjects(key.itemID,order.property,null,items);};}else{values.visit(function(value){keys.push({display:value});});compareKeys=function(key1,key2){return key1.display.localeCompare(key2.display);};retrieveItems=order.forward?function(key){return database.getSubjects(key.display,order.property,null,items);}:function(key){return database.getObjects(key.display,order.property,null,items);};}
keys.sort(function(key1,key2){return(order.ascending?1:-1)*compareKeys(key1,key2);});for(var k=0;k<keys.length;k++){var key=keys[k];key.items=retrieveItems(key);if(!self._showDuplicates){items.removeSet(key.items);}}
return keys;};var processNumericLevel=function(items,index,values,valueType){var keys=[];var keyMap={};var order=orders[index];var valueParser;if(valueType=="number"){valueParser=function(value){if(typeof value=="number"){return value;}else{try{return parseFloat(value);}catch(e){return null;}}};}else{valueParser=function(value){if(value instanceof Date){return value.getTime();}else{try{return SimileAjax.DateTime.parseIso8601DateTime(value.toString()).getTime();}catch(e){return null;}}};}
values.visit(function(value){var sortkey=valueParser(value);if(sortkey!=null){var key=keyMap[sortkey];if(!key){key={sortkey:sortkey,display:value,values:[],items:new Exhibit.Set()};keyMap[sortkey]=key;keys.push(key);}
key.values.push(value);}});keys.sort(function(key1,key2){return(order.ascending?1:-1)*(key1.sortkey-key2.sortkey);});for(var k=0;k<keys.length;k++){var key=keys[k];var values=key.values;for(var v=0;v<values.length;v++){if(order.forward){database.getSubjects(values[v],order.property,key.items,items);}else{database.getObjects(values[v],order.property,key.items,items);}}
if(!self._showDuplicates){items.removeSet(key.items);}}
return keys;};processLevel(allItems,0);return hasSomeGrouping;};Exhibit.OrderedViewFrame.prototype._openSortPopup=function(elmt,index){var self=this;var database=this._exhibit.getDatabase();var popupDom=Exhibit.Theme.createPopupMenuDom(elmt);if(index>=0){var order=this._orders[index];var property=database.getProperty(order.property);var propertyLabel=order.forward?property.getPluralLabel():property.getReversePluralLabel();var valueType=order.forward?property.getValueType():"item";var sortLabels=Exhibit.Database.l10n.sortLabels[valueType];sortLabels=(sortLabels!=null)?sortLabels:Exhibit.Database.l10n.sortLabels["text"];popupDom.appendMenuItem(sortLabels.ascending,Exhibit.Theme.urlPrefix+
(order.ascending?"images/option-check.png":"images/option.png"),order.ascending?function(){}:function(){self._reSort(index,order.property,order.forward,true,false);});popupDom.appendMenuItem(sortLabels.descending,Exhibit.Theme.urlPrefix+
(order.ascending?"images/option.png":"images/option-check.png"),order.ascending?function(){self._reSort(index,order.property,order.forward,false,false);}:function(){});if(this._orders.length>1){popupDom.appendSeparator();popupDom.appendMenuItem(Exhibit.OrderedViewFrame.l10n.removeOrderLabel,null,function(){self._removeOrder(index);});}}
var orders=[];for(var i=0;i<this._possibleOrders.length;i++){var possibleOrder=this._possibleOrders[i];var skip=false;for(var j=(index<0)?this._orders.length-1:index;j>=0;j--){var existingOrder=this._orders[j];if(existingOrder.property==possibleOrder.property&&existingOrder.forward==possibleOrder.forward){skip=true;break;}}
if(!skip){var property=database.getProperty(possibleOrder.property);orders.push({property:possibleOrder.property,forward:possibleOrder.forward,ascending:possibleOrder.ascending,label:possibleOrder.forward?property.getPluralLabel():property.getReversePluralLabel()});}}
if(orders.length>0){if(index>=0){popupDom.appendSeparator();}
orders.sort(function(order1,order2){return order1.label.localeCompare(order2.label);});var appendOrder=function(order){popupDom.appendMenuItem(order.label,null,function(){self._reSort(index,order.property,order.forward,order.ascending,true);});}
for(var i=0;i<orders.length;i++){appendOrder(orders[i]);}}
popupDom.open();};Exhibit.OrderedViewFrame.prototype._reSort=function(index,propertyID,forward,ascending,slice){index=(index<0)?this._orders.length:index;var oldOrders=this._orders;var newOrders=this._orders.slice(0,index);newOrders.push({property:propertyID,forward:forward,ascending:ascending});if(!slice){newOrders=newOrders.concat(oldOrders.slice(index+1));}
var property=this._exhibit.getDatabase().getProperty(propertyID);var propertyLabel=forward?property.getPluralLabel():property.getReversePluralLabel();var valueType=forward?property.getValueType():"item";var sortLabels=Exhibit.Database.l10n.sortLabels[valueType];sortLabels=(sortLabels!=null)?sortLabels:Exhibit.Database.l10n.sortLabels["text"];var self=this;SimileAjax.History.addAction({perform:function(){self._orders=newOrders;self.parentReconstruct();},undo:function(){self._orders=oldOrders;self.parentReconstruct();},label:Exhibit.OrderedViewFrame.l10n.formatSortActionTitle(propertyLabel,ascending?sortLabels.ascending:sortLabels.descending),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.OrderedViewFrame.prototype._removeOrder=function(index){var oldOrders=this._orders;var newOrders=this._orders.slice(0,index).concat(this._orders.slice(index+1));var order=oldOrders[index];var property=this._exhibit.getDatabase().getProperty(order.property);var propertyLabel=order.forward?property.getPluralLabel():property.getReversePluralLabel();var valueType=order.forward?property.getValueType():"item";var sortLabels=Exhibit.Database.l10n.sortLabels[valueType];sortLabels=(sortLabels!=null)?sortLabels:Exhibit.Database.l10n.sortLabels["text"];var self=this;SimileAjax.History.addAction({perform:function(){self._orders=newOrders;self.parentReconstruct();},undo:function(){self._orders=oldOrders;self.parentReconstruct();},label:Exhibit.OrderedViewFrame.l10n.formatRemoveOrderActionTitle(propertyLabel,order.ascending?sortLabels.ascending:sortLabels.descending),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.OrderedViewFrame.prototype._setShowAll=function(showAll){this._showAll=showAll;this.parentReconstruct();};Exhibit.OrderedViewFrame.prototype._toggleGroup=function(){var oldGrouped=this._grouped;var self=this;SimileAjax.History.addAction({perform:function(){self._grouped=!oldGrouped;self.parentReconstruct();},undo:function(){self._grouped=oldGrouped;self.parentReconstruct();},label:Exhibit.OrderedViewFrame.l10n[oldGrouped?"ungroupActionTitle":"groupAsSortedActionTitle"],uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.OrderedViewFrame.prototype._toggleShowDuplicates=function(){var oldShowDuplicates=this._showDuplicates;var self=this;SimileAjax.History.addAction({perform:function(){self._showDuplicates=!oldShowDuplicates;self.parentReconstruct();},undo:function(){self._showDuplicates=oldShowDuplicates;self.parentReconstruct();},label:Exhibit.OrderedViewFrame.l10n[oldShowDuplicates?"hideDuplicatesActionTitle":"showDuplicatesActionTitle"],uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};

/* tabular-view.js */

Exhibit.TabularView=function(exhibit,div,configuration,domConfiguration,globalConfiguration){this._exhibit=exhibit;this._div=div;this._configuration=configuration;this._globalConfiguration=globalConfiguration;this._initialCount=10;this._showAll=true;this._columns=[];this._sortColumn=0;this._sortAscending=true;this._rowStyler=null;this._tableStyler=null;if(domConfiguration!=null){var expressions=[];var labels=[];var formats=[];var s=Exhibit.getAttribute(domConfiguration,"columns");if(s!=null&&s.length>0){expressions=Exhibit.Expression.parseSeveral(s);}
s=Exhibit.getAttribute(domConfiguration,"columnLabels");if(s!=null&&s.length>0){var a=s.split(",");for(var i=0;i<a.length;i++){labels.push(a[i].trim());}}
s=Exhibit.getAttribute(domConfiguration,"columnFormats");if(s!=null&&s.length>0){var a=s.split(",");for(var i=0;i<a.length;i++){formats.push(a[i].trim());}}
for(var i=0;i<expressions.length;i++){var expression=expressions[i];var format=formats[i];if(format==null){format="list";}
this._columns.push({expression:expression,styler:null,label:labels[i],format:format});}
s=Exhibit.getAttribute(domConfiguration,"sortColumn");if(s!=null){this._sortColumn=parseInt(s);}
s=Exhibit.getAttribute(domConfiguration,"sortAscending");if(s!=null){this._sortAscending=(s=="true");}
s=Exhibit.getAttribute(domConfiguration,"initialCount");if(s!=null){this._initialCount=parseInt(s);}
s=Exhibit.getAttribute(domConfiguration,"showAll");if(s!=null){this._showAll=(s=="true");}
s=Exhibit.getAttribute(domConfiguration,"rowStyler");if(s!=null){var f=eval(s);if(typeof f=="function"){this._rowStyler=f;}}
s=Exhibit.getAttribute(domConfiguration,"tableStyler");if(s!=null){f=eval(s);if(typeof f=="function"){this._tableStyler=f;}}}
if("columns"in configuration){var columns=configuration.columns;for(var i=0;i<columns.length;i++){var column=columns[i];var expr;var styler=null;var label=null;var format=null;if(typeof column=="string"){expr=column;}else{expr=column.expression;styler=column.styler;label=column.label;format=column.format;}
var expression=Exhibit.Expression.parse(expr);if(expression.isPath()){var path=expression.getPath();if(format==null){format="list";}
this._columns.push({expression:expression,styler:styler,label:label,format:format});}}}
if("sortColumn"in configuration){this._sortColumn=configuration.sortColumn;}
if("sortAscending"in configuration){this._sortAscending=(configuration.sortAscending);}
if("initialCount"in configuration){this._initialCount=configuration.initialCount;}
if("showAll"in configuration){this._showAll=configuration.showAll;}
if("rowStyler"in configuration){this._rowStyler=configuration.rowStyler;}
if("tableStyler"in configuration){this._tableStyler=configuration.tableStyler;}
if(this._columns.length==0){var database=this._exhibit.getDatabase();var propertyIDs=database.getAllProperties();for(var i=0;i<propertyIDs.length;i++){var propertyID=propertyIDs[i];if(propertyID!="uri"){this._columns.push({expression:Exhibit.Expression.parse("."+propertyID),styler:null,label:database.getProperty(propertyID).getLabel(),format:"list"});}}}
this._sortColumn=Math.max(0,Math.min(this._sortColumn,this._columns.length-1));this._initializeUI();var view=this;this._listener={onChange:function(handlerName){if(handlerName!="onGroup"&&handlerName!="onUngroup"){view._reconstruct();}}};this._exhibit.getBrowseEngine().addListener(this._listener);};Exhibit.TabularView.prototype.dispose=function(){this._exhibit.getBrowseEngine().removeListener(this._listener);this._div.innerHTML="";this._dom=null;this._div=null;this._exhibit=null;};Exhibit.TabularView.prototype._initializeUI=function(){var self=this;this._div.innerHTML="";this._dom=Exhibit.TabularView.theme.createDom(this._exhibit,this._div,function(elmt,evt,target){self._exhibit.getViewPanel().resetBrowseQuery();SimileAjax.DOM.cancelEvent(evt);return false;});this._reconstruct();};Exhibit.TabularView.prototype._reconstruct=function(){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var bodyDiv=this._dom.bodyDiv;bodyDiv.innerHTML="";var collection=exhibit.getBrowseEngine().getCurrentCollection();var items=[];var originalSize=0;if(collection!=null){var currentSet=collection.getCurrentSet();currentSet.visit(function(itemID){items.push({id:itemID,sortKey:""});});originalSize=collection.originalSize();}
this._dom.setCounts(items.length,originalSize);if(items.length>0){this._dom.setTypes(database.getTypeLabels(currentSet)[items.length>1?1:0]);var sortColumn=this._columns[this._sortColumn];items.sort(this._createSortFunction(items,sortColumn.expression,this._sortAscending));var table=document.createElement("table");table.cellPadding=5;table.border=1;if(this._tableStyler!=null){this._tableStyler(table,database);}
var max=this._showAll?items.length:Math.min(items.length,this._initialCount);for(var i=0;i<max;i++){var item=items[i];var tr=table.insertRow(i);if(this._rowStyler!=null){this._rowStyler(item.id,database,tr,i);}
for(var c=0;c<this._columns.length;c++){var column=this._columns[c];var td=tr.insertCell(c);var results=column.expression.evaluate({"value":item.id},{"value":"item"},"value",database);switch(column.format){case"image":results.values.visit(function(url){var img=document.createElement("img");img.src=url;td.appendChild(img);});break;default:Exhibit.TabularView._constructDefaultValueList(results.values,results.valueType,td,exhibit);}
if(column.styler!=null){column.styler(item.id,database,td);}}}
var th=table.createTHead();tr=th.insertRow(0);var createColumnHeader=function(i){var column=self._columns[i];if(column.label==null){column.label=self._getColumnLabel(column.expression);}
var colgroup=document.createElement("colgroup");colgroup.className=column.label;table.appendChild(colgroup);var td=document.createElement("th");Exhibit.TabularView.theme.createColumnHeader(exhibit,td,column.label,i==self._sortColumn,self._sortAscending,function(elmt,evt,target){self._doSort(i);SimileAjax.DOM.cancelEvent(evt);return false;});tr.appendChild(td);};for(var i=0;i<this._columns.length;i++){createColumnHeader(i);}
bodyDiv.appendChild(table);}};Exhibit.TabularView.prototype._getColumnLabel=function(expression){var database=this._exhibit.getDatabase();var path=expression.getPath();var segment=path.getSegment(path.getSegmentCount()-1);var propertyID=segment.property;var property=database.getProperty(propertyID);if(property!=null){return segment.forward?property.getLabel():property.getReverseLabel();}else{return propertyID;}};Exhibit.TabularView.prototype._createSortFunction=function(items,expression,ascending){var database=this._exhibit.getDatabase();var multiply=ascending?1:-1;var numericFunction=function(item1,item2){return multiply*(item1.sortKey-item2.sortKey);};var textFunction=function(item1,item2){return multiply*item1.sortKey.localeCompare(item2.sortKey);};var valueTypes=[];var valueTypeMap={};for(var i=0;i<items.length;i++){var item=items[i];var r=expression.evaluate({"value":item.id},{"value":"item"},"value",database);r.values.visit(function(value){item.sortKey=value;});if(!(r.valueType in valueTypeMap)){valueTypeMap[r.valueType]=true;valueTypes.push(r.valueType);}}
var coercedValueType="text"
if(valueTypes.length==1){coercedValueType=valueTypes[0];}else{coercedValueType="text";}
var coersion;var sortingFunction;if(coercedValueType=="number"){sortingFunction=numericFunction;coersion=function(v){if(v==null){return Number.NEGATIVE_INFINITY;}else if(typeof v=="number"){return v;}else{var n=parseFloat(v);if(isNaN(n)){return Number.NEGATIVE_INFINITY;}else{return n;}}}}else if(coercedValueType=="date"){sortingFunction=numericFunction;coersion=function(v){if(v==null){return Number.NEGATIVE_INFINITY;}else if(v instanceof Date){return v.getTime();}else{try{return SimileAjax.DateTime.parseIso8601DateTime(v).getTime();}catch(e){return Number.NEGATIVE_INFINITY;}}}}else if(coercedValueType=="boolean"){sortingFunction=numericFunction;coersion=function(v){if(v==null){return Number.NEGATIVE_INFINITY;}else if(typeof v=="boolean"){return v?1:0;}else{return v.toString().toLowerCase()=="true";}}}else if(coercedValueType=="item"){sortingFunction=textFunction;coersion=function(v){if(v==null){return Exhibit.l10n.missingSortKey;}else{var label=database.getObject(v,"label");return(label==null)?v:label;}}}else{sortingFunction=textFunction;coersion=function(v){if(v==null){return Exhibit.l10n.missingSortKey;}else{return v.toString();}}}
for(var i=0;i<items.length;i++){var item=items[i];item.sortKey=coersion(item.sortKey);}
return sortingFunction;};Exhibit.TabularView.prototype._doSort=function(columnIndex){var oldSortColumn=this._sortColumn;var oldSortAscending=this._sortAscending;var newSortColumn=columnIndex;var newSortAscending=oldSortColumn==newSortColumn?!oldSortAscending:true;var self=this;SimileAjax.History.addAction({perform:function(){self._sortColumn=newSortColumn;self._sortAscending=newSortAscending;self._reconstruct();},undo:function(){self._sortColumn=oldSortColumn;self._sortAscending=oldSortAscending;self._reconstruct();},label:Exhibit.TabularView.l10n.makeSortActionTitle(this._columns[columnIndex].label,newSortAscending),uiLayer:SimileAjax.WindowManager.getBaseLayer(),lengthy:true});};Exhibit.TabularView._constructDefaultValueList=function(values,valueType,parentElmt,exhibit){var processOneValue=(valueType=="item")?function(value){addDelimiter();parentElmt.appendChild(exhibit.makeItemSpan(value));}:function(value){addDelimiter();parentElmt.appendChild(exhibit.makeValueSpan(value,valueType));};var addDelimiter=Exhibit.l10n.createListDelimiter(parentElmt,values.size());values.visit(processOneValue);addDelimiter();};

/* thumbnail-view.js */

Exhibit.ThumbnailView=function(exhibit,div,configuration,domConfiguration,globalConfiguration){this._exhibit=exhibit;this._div=div;this._configuration=configuration;this._domConfiguration=domConfiguration;this._globalConfiguration=globalConfiguration;this._lensConfiguration={};if(domConfiguration!=null){Exhibit.ViewPanel.extractItemLensDomConfiguration(domConfiguration,this._lensConfiguration);}
if("lensSelector"in configuration){if(!("Lens"in this._lensConfiguration)){this._lensConfiguration["Lens"]={};}
this._lensConfiguration["Lens"].lensSelector=configuration.lensSelector;}
this._initializeUI();var view=this;this._listener={onChange:function(handlerName){if(handlerName!="onGroup"&&handlerName!="onUngroup"){view._reconstruct();}}};this._exhibit.getBrowseEngine().addListener(this._listener);};Exhibit.ThumbnailView.prototype.dispose=function(){this._exhibit.getBrowseEngine().removeListener(this._listener);this._div.innerHTML="";this._orderedViewFrame.dispose();this._orderedViewFrame=null;this._dom=null;this._div=null;this._exhibit=null;};Exhibit.ThumbnailView.prototype._initializeUI=function(){this._div.innerHTML="";var template={elmt:this._div,children:[{tag:"div",field:"headerDiv"},{tag:"div",className:"exhibit-collectionView-body",field:"bodyDiv"},{tag:"div",field:"footerDiv"}]};this._dom=SimileAjax.DOM.createDOMFromTemplate(document,template);this._orderedViewFrame=new Exhibit.OrderedViewFrame(this._exhibit,this._dom.headerDiv,this._dom.footerDiv,this._configuration,this._domConfiguration);var self=this;this._orderedViewFrame.parentReconstruct=function(){self._reconstruct();}
this._reconstruct();};Exhibit.ThumbnailView.prototype._reconstruct=function(){var view=this;var state={div:this._dom.bodyDiv,itemContainer:null,groupDoms:[],groupCounts:[]};var closeGroups=function(groupLevel){for(var i=groupLevel;i<state.groupDoms.length;i++){state.groupDoms[i].countSpan.innerHTML=state.groupCounts[i];}
state.groupDoms=state.groupDoms.slice(0,groupLevel);state.groupCounts=state.groupCounts.slice(0,groupLevel);if(groupLevel>0){state.div=state.groupDoms[groupLevel-1].contentDiv;}else{state.div=view._dom.bodyDiv;}
state.itemContainer=null;}
this._orderedViewFrame.onNewGroup=function(groupSortKey,keyType,groupLevel){closeGroups(groupLevel);var groupDom=Exhibit.ThumbnailView.theme.constructGroup(view._exhibit,groupLevel,groupSortKey);state.div.appendChild(groupDom.elmt);state.div=groupDom.contentDiv;state.groupDoms.push(groupDom);state.groupCounts.push(0);};this._orderedViewFrame.onNewItem=function(itemID,index){if(state.itemContainer==null){state.itemContainer=Exhibit.ThumbnailView.theme.constructItemContainer(view._exhibit);state.div.appendChild(state.itemContainer);}
for(var i=0;i<state.groupCounts.length;i++){state.groupCounts[i]++;}
var itemLensDiv=document.createElement("div");itemLensDiv.className=SimileAjax.Platform.browser.isIE?"exhibit-thumbnailView-itemContainer-IE":"exhibit-thumbnailView-itemContainer";var itemLens=new Exhibit.Lens(itemID,itemLensDiv,view._exhibit,view._lensConfiguration);state.itemContainer.appendChild(itemLensDiv);};this._div.style.display="none";this._dom.bodyDiv.innerHTML="";this._orderedViewFrame.reconstruct();closeGroups(0);this._div.style.display="block";};

/* tile-view.js */

Exhibit.TileView=function(exhibit,div,configuration,domConfiguration,globalConfiguration){this._exhibit=exhibit;this._div=div;this._configuration=configuration;this._domConfiguration=domConfiguration;this._globalConfiguration=globalConfiguration;this._initializeUI();var view=this;this._listener={onChange:function(handlerName){if(handlerName!="onGroup"&&handlerName!="onUngroup"){view._reconstruct();}}};this._exhibit.getBrowseEngine().addListener(this._listener);};Exhibit.TileView.prototype.dispose=function(){this._exhibit.getBrowseEngine().removeListener(this._listener);this._div.innerHTML="";this._orderedViewFrame.dispose();this._orderedViewFrame=null;this._dom=null;this._div=null;this._exhibit=null;};Exhibit.TileView.prototype._initializeUI=function(){this._div.innerHTML="";var template={elmt:this._div,children:[{tag:"div",field:"headerDiv"},{tag:"div",className:"exhibit-collectionView-body",field:"bodyDiv"},{tag:"div",field:"footerDiv"}]};this._dom=SimileAjax.DOM.createDOMFromTemplate(document,template);this._orderedViewFrame=new Exhibit.OrderedViewFrame(this._exhibit,this._dom.headerDiv,this._dom.footerDiv,this._configuration,this._domConfiguration);var self=this;this._orderedViewFrame.parentReconstruct=function(){self._reconstruct();}
this._reconstruct();};Exhibit.TileView.prototype._reconstruct=function(){var view=this;var state={div:this._dom.bodyDiv,table:null,groupDoms:[],groupCounts:[]};var closeGroups=function(groupLevel){for(var i=groupLevel;i<state.groupDoms.length;i++){state.groupDoms[i].countSpan.innerHTML=state.groupCounts[i];}
state.groupDoms=state.groupDoms.slice(0,groupLevel);state.groupCounts=state.groupCounts.slice(0,groupLevel);if(groupLevel>0){state.div=state.groupDoms[groupLevel-1].contentDiv;}else{state.div=view._dom.bodyDiv;}
state.table=null;}
this._orderedViewFrame.onNewGroup=function(groupSortKey,keyType,groupLevel){closeGroups(groupLevel);var groupDom=Exhibit.TileView.theme.constructGroup(view._exhibit,groupLevel,groupSortKey);state.div.appendChild(groupDom.elmt);state.div=groupDom.contentDiv;state.groupDoms.push(groupDom);state.groupCounts.push(0);};this._orderedViewFrame.onNewItem=function(itemID,index){if(state.table==null){state.table=Exhibit.TileView.theme.constructTable(view._exhibit);state.div.appendChild(state.table);}
for(var i=0;i<state.groupCounts.length;i++){state.groupCounts[i]++;}
var rows=state.table.rows;var tr=state.table.insertRow(rows.length);var tdIndex=tr.insertCell(0);tdIndex.className="exhibit-tileView-itemIndex";tdIndex.innerHTML=(index+1)+".";var tdItemLens=tr.insertCell(1);var itemLensDiv=document.createElement("div");var itemLens=new Exhibit.Lens(itemID,itemLensDiv,view._exhibit,view._globalConfiguration);tdItemLens.appendChild(itemLensDiv);};this._div.style.display="none";this._dom.bodyDiv.innerHTML="";this._orderedViewFrame.reconstruct();closeGroups(0);this._div.style.display="block";};

/* timeline-view.js */

Exhibit.TimelineView=function(exhibit,div,configuration,domConfiguration,globalConfiguration){this._exhibit=exhibit;this._div=div;this._configuration=configuration;this._globalConfiguration=globalConfiguration;this._lensConfiguration={};if("Lens"in globalConfiguration){this._lensConfiguration["Lens"]=globalConfiguration["Lens"];}
if(domConfiguration!=null){Exhibit.ViewPanel.extractItemLensDomConfiguration(domConfiguration,this._lensConfiguration);}
if("lensSelector"in configuration){if(!("Lens"in this._lensConfiguration)){this._lensConfiguration["Lens"]={};}
this._lensConfiguration["Lens"].lensSelector=configuration.lensSelector;}
this._densityFactor=50;this._topBandIntervalPixels=150;this._bottomBandIntervalPixels=200;this._bubbleWidth=400;this._bubbleHeight=300;this._timelineConstructor=null;var getDurations=null;try{var getStart=null;var getEnd=null;var makeAccessor=function(expression){var expr=Exhibit.Expression.parse(expression);return function(itemID,database){var v=expr.evaluateSingle({"value":itemID},{"value":"item"},"value",database).value;if(v==null){return v;}else if(v instanceof Date){return v;}else{return SimileAjax.DateTime.parseIso8601DateTime(v);}};};if(domConfiguration!=null){var start=Exhibit.getAttribute(domConfiguration,"start");if(start!=null&&start.length>0){getStart=makeAccessor(start);}}
if("start"in configuration){getStart=makeAccessor(configuration.start);}
getStart=getStart!=null?getStart:function(itemID,database){return null;}
if(domConfiguration!=null){var end=Exhibit.getAttribute(domConfiguration,"end");if(end!=null&&end.length>0){getEnd=makeAccessor(end);}}
if("end"in configuration){getEnd=makeAccessor(configuration.end);}
getEnd=getEnd!=null?getEnd:function(itemID,database){return null;}
var getStartEnd=function(itemID,database){return{start:getStart(itemID,database),end:getEnd(itemID,database)};}
var makeGetDurations=function(s){var expr=Exhibit.Expression.parse(s);return function(itemID,database){var pairs=[];expr.evaluate({"value":itemID},{"value":"item"},"value",database).values.visit(function(v){var startEnd=getStartEnd(v,database);if(startEnd.start!=null){pairs.push(startEnd);}});return pairs;};};if(domConfiguration!=null){var proxy=Exhibit.getAttribute(domConfiguration,"proxy");if(proxy!=null&&proxy.length>0){getDurations=makeGetDurations(proxy);}}
if("proxy"in configuration){getDurations=makeGetDurations(configuration.proxy);}
getDurations=getDurations!=null?getDurations:getStartEnd;if(domConfiguration!=null){var topBandIntervalPixels=Exhibit.getAttribute(domConfiguration,"topBandIntervalPixels");if(topBandIntervalPixels!=null&&topBandIntervalPixels.length>0){this._topBandIntervalPixels=parseInt(topBandIntervalPixels);}
var bottomBandIntervalPixels=Exhibit.getAttribute(domConfiguration,"bottomBandIntervalPixels");if(bottomBandIntervalPixels!=null&&bottomBandIntervalPixels.length>0){this._bottomBandIntervalPixels=parseInt(bottomBandIntervalPixels);}
var densityFactor=Exhibit.getAttribute(domConfiguration,"densityFactor");if(densityFactor!=null&&densityFactor.length>0){this._densityFactor=parseFloat(densityFactor);}
var bubbleWidth=Exhibit.getAttribute(domConfiguration,"bubbleWidth");if(bubbleWidth!=null&&bubbleWidth.length>0){this._bubbleWidth=parseInt(bubbleWidth);}
var bubbleHeight=Exhibit.getAttribute(domConfiguration,"bubbleHeight");if(bubbleHeight!=null&&bubbleHeight.length>0){this._bubbleHeight=parseInt(bubbleHeight);}
var timelineConstructor=Exhibit.getAttribute(domConfiguration,"timelineConstructor");if(timelineConstructor!=null){var f=eval(timelineConstructor);if(typeof f=="function"){this._timelineConstructor=f;}}}
if("topBandIntervalPixels"in configuration){this._topBandIntervalPixels=configuration.topBandIntervalPixels;}
if("bottomBandIntervalPixels"in configuration){this._bottomBandIntervalPixels=configuration.bottomBandIntervalPixels;}
if("densityFactor"in configuration){this._densityFactor=configuration.densityFactor;}
if("bubbleWidth"in configuration){this._bubbleWidth=configuration.bubbleWidth;}
if("bubbleHeight"in configuration){this._bubbleHeight=configuration.bubbleHeight;}
if("timelineConstructor"in configuration){this._timelineConstructor=configuration.timelineConstructor;}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing configuration of timeline view",e);}
var getMarkerKey=null;try{var makeGetMarker=function(s){var markerExpression=Exhibit.Expression.parse(s);return function(itemID,database){var key=markerExpression.evaluateSingle({"value":itemID},{"value":"item"},"value",database).value;return key!=null?key:"";}};if(domConfiguration!=null){var marker=Exhibit.getAttribute(domConfiguration,"marker");if(marker!=null&&marker.length>0){getMarkerKey=makeGetMarker(marker);}}
if("marker"in configuration){getMarkerKey=makeGetMarker(configuration.marker);}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing marker configuration of timeline view",e);}
this._getDurations=(getDurations!=null)?getDurations:function(itemID,database){return{};};this._getMarkerKey=(getMarkerKey!=null)?getMarkerKey:function(itemID,database){return"";};var getEventLabel=null;var makeEventLabel=function(s){var expression=Exhibit.Expression.parse(s);return function(itemID,database){var label=expression.evaluateSingle({"value":itemID},{"value":"item"},"value",database).value;return label!=null?label:itemID;}};try{if(domConfiguration!=null){var eventLabel=Exhibit.getAttribute(domConfiguration,"eventLabel");if(eventLabel!=null&&eventLabel.length>0){getEventLabel=makeEventLabel(eventLabel);}}
if("eventLabel"in configuration){getEventLabel=makeEventLabel(configuration.eventLabel);}}catch(e){SimileAjax.Debug.exception("TimelineView: Error processing eventLabel configuration of timeline view",e);}
this._getEventLabel=(getEventLabel!=null)?getEventLabel:makeEventLabel(".label");this._durationCache=new Object();this._markerKeyCache=new Object();this._markerCache=new Object();this._maxMarker=0;this._largestSize=0;this._initializeUI();var view=this;this._listener={onChange:function(handlerName){if(handlerName!="onGroup"&&handlerName!="onUngroup"){view._reconstruct();}}};this._exhibit.getBrowseEngine().addListener(this._listener);};Exhibit.TimelineView.prototype.dispose=function(){this._exhibit.getBrowseEngine().removeListener(this._listener);this._dom.timeline=null;this._dom=null;this._div.innerHTML="";this._div=null;this._exhibit=null;};Exhibit.TimelineView.prototype._initializeUI=function(){var self=this;this._div.innerHTML="";this._dom=Exhibit.TimelineView.theme.constructDom(this._exhibit,this._div,function(elmt,evt,target){self._exhibit.getViewPanel().resetBrowseQuery();SimileAjax.DOM.cancelEvent(evt);return false;},function(elmt,evt,target){self._largestSize=0;self._reconstruct();SimileAjax.DOM.cancelEvent(evt);return false;});this._eventSource=new Timeline.DefaultEventSource();this._reconstruct();};Exhibit.TimelineView.prototype._reconstructTimeline=function(newEvents){if(this._dom.timeline!=null){this._dom.timeline.dispose();}
if(newEvents){this._eventSource.addMany(newEvents);}
var timelineDiv=this._dom.getTimelineDiv();if(this._timelineConstructor!=null){this._dom.timeline=this._timelineConstructor(timelineDiv,this._eventSource);}else{timelineDiv.style.height="400px";var earliest=this._eventSource.getEarliestDate();var latest=this._eventSource.getLatestDate();var duration=latest.getTime()-earliest.getTime();var intervalUnit=Timeline.DateTime.MILLENNIUM;while(intervalUnit>0){var intervalLength=Timeline.DateTime.gregorianUnitLengths[intervalUnit];if(duration/intervalLength>this._densityFactor){break;}
intervalUnit--;}
var theme=Timeline.ClassicTheme.create();theme.event.bubble.width=this._bubbleWidth;theme.event.bubble.height=this._bubbleHeight;var bandInfos=[Timeline.createBandInfo({width:"75%",intervalUnit:intervalUnit,intervalPixels:this._topBandIntervalPixels,eventSource:this._eventSource,theme:theme}),Timeline.createBandInfo({width:"25%",intervalUnit:intervalUnit+1,intervalPixels:this._bottomBandIntervalPixels,eventSource:this._eventSource,showEventText:false,trackHeight:0.5,trackGap:0.2,theme:theme})];bandInfos[1].syncWith=0;bandInfos[1].highlight=true;bandInfos[1].eventPainter.setLayout(bandInfos[0].eventPainter.getLayout());this._dom.timeline=Timeline.create(timelineDiv,bandInfos,Timeline.HORIZONTAL);}};Exhibit.TimelineView.prototype._reconstruct=function(){var self=this;var exhibit=this._exhibit;var database=exhibit.getDatabase();var collection=exhibit.getBrowseEngine().getCurrentCollection();var originalSize=0;var currentSize=0;var plottableSize=0;if(collection!=null){originalSize=collection.originalSize();var currentSet=collection.getCurrentSet();currentSize=currentSet.size();}
var usedKeys={};this._dom.clearLegend();this._eventSource.clear();if(currentSize>0){var events=[];var addEvent=function(itemID,duration,markerData){var evt=new Timeline.DefaultEventSource.Event(duration.start,duration.end,null,null,duration.end==null,self._getEventLabel(itemID,database),"no description",null,null,null,"#"+markerData.color,"#"+(duration.end==null?markerData.color:markerData.textColor));evt._itemID=itemID;evt.getProperty=function(name){return database.getObject(this._itemID,name);};evt.fillInfoBubble=function(elmt,theme,labeller){self._fillInfoBubble(this,elmt,theme,labeller);};events.push(evt);};currentSet.visit(function(itemID){var durations;if(itemID in self._durationCache){durations=self._durationCache[itemID];}else{durations=self._getDurations(itemID,database);self._durationCache[itemID]=durations;}
if((durations instanceof Array&&durations.length>0)||(durations.start!=null)){plottableSize++;var markerKey;if(itemID in self._markerKeyCache){markerKey=self._markerKeyCache[itemID];}else{markerKey=self._getMarkerKey(itemID,database);self._markerKeyCache[itemID]=markerKey;}
usedKeys[markerKey]=true;if(markerKey in self._markerCache){markerData=self._markerCache[markerKey];}else{markerData=Exhibit.TimelineView.theme.markers[self._maxMarker];self._markerCache[markerKey]=markerData;self._maxMarker=(self._maxMarker+1)%Exhibit.TimelineView.theme.markers.length;}
if(durations instanceof Array){for(var i=0;i<durations.length;i++){addEvent(itemID,durations[i],markerData);}}else{addEvent(itemID,durations,markerData);}}});if(plottableSize>this._largestSize){this._largestSize=plottableSize;this._reconstructTimeline(events);}else{this._eventSource.addMany(events);}
var legendLabels=[];var legendColors=[];for(markerKey in this._markerCache){if(markerKey in usedKeys){var markerData=this._markerCache[markerKey];legendLabels.push(markerKey);legendColors.push("#"+markerData.color);}}
this._dom.addLegendBlock(Exhibit.TimelineView.theme.constructLegendBlockDom(this._exhibit,Exhibit.TimelineView.l10n.colorLegendTitle,legendColors,legendLabels));this._dom.setTypes(database.getTypeLabels(currentSet)[currentSize>1?1:0]);var band=this._dom.timeline.getBand(0);var centerDate=band.getCenterVisibleDate();if(centerDate<this._eventSource.getEarliestDate()){band.scrollToCenter(this._eventSource.getEarliestDate());}else if(centerDate>this._eventSource.getLatestDate()){band.scrollToCenter(this._eventSource.getLatestDate());}}
this._dom.setCounts(currentSize,plottableSize,originalSize);};Exhibit.TimelineView.prototype._fillInfoBubble=function(evt,elmt,theme,labeller){new Exhibit.Lens(evt._itemID,elmt,this._exhibit,this._lensConfiguration);};